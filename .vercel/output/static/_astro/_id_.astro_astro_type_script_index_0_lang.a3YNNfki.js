import{u as x,r as q,b as F,d as D}from"./misas.DRDL5bBN.js";import{d as B,c as a,b as L,s as M}from"./alerts.CXiBSr95.js";import{S as z}from"./sweetalert2.esm.all.BbQndx0i.js";import"./songs.Cv0urTgp.js";const I=()=>{document.querySelectorAll('button[data-action="edit-tone"]').forEach(t=>{const o=t.cloneNode(!0);t.parentNode?.replaceChild(o,t),o.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const n=e.currentTarget,c=n.getAttribute("data-current-tone"),i=Number(n.getAttribute("data-misa-id")),m=Number(n.getAttribute("data-misa-song-id")),d=document.querySelector("main")?.getAttribute("data-token"),l=document.querySelector("main")?.getAttribute("data-edit-token"),{value:s}=await z.fire({title:"Cambiar Tono",input:"text",inputLabel:"Nuevo tono (ej: Do, Re, Mim)",inputValue:c||"",showCancelButton:!0,confirmButtonColor:"#f97316",cancelButtonColor:"#4b5563",confirmButtonText:"Guardar",background:"#1f2937",color:"#fff",inputValidator:r=>{if(!r)return"Debes escribir un tono"}});if(s&&s!==c){B("Actualizando...");try{const r=await x(i,m,s,d||void 0,l||void 0);r.success?window.location.reload():a("Error",r.error||"No se pudo actualizar el tono.")}catch{a("Error","Error de conexión.")}}})}),document.querySelectorAll(".add-song-btn").forEach(t=>{t.getAttribute("data-listener-attached")!=="true"&&(t.setAttribute("data-listener-attached","true"),t.addEventListener("click",()=>{const o=t.getAttribute("data-moment-id");console.log("Dispatching open-add-song-modal event",{momentId:o}),window.dispatchEvent(new CustomEvent("open-add-song-modal",{detail:{momentId:o}}))}))}),document.querySelectorAll('button[data-action="delete-song"]').forEach(t=>{const o=t.cloneNode(!0);t.parentNode?.replaceChild(o,t),o.addEventListener("click",async e=>{e.preventDefault();const n=e.currentTarget;if(!(await L("¿Eliminar canción?","No podrás deshacer esta acción","Sí, eliminar")).isConfirmed)return;const i=Number(n.getAttribute("data-misa-id")),m=Number(n.getAttribute("data-misa-song-id")),d=document.querySelector("main")?.getAttribute("data-token"),l=document.querySelector("main")?.getAttribute("data-edit-token");if(i&&m&&(d||l)){B("Eliminando...");try{const s=await q(i,m,d||void 0,l||void 0);s.success?window.location.reload():a("Error",s.error||"Error al eliminar.")}catch{a("Error","Error de conexión.")}}})});const A=async(t,o,e)=>{try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t),M(o,e);else throw new Error("Clipboard API not available")}catch(n){console.error("Error al copiar",n),a("Error","No se pudo copiar el enlace. Intenta hacerlo manualmente.")}},E=document.getElementById("copyShareLinkBtn");if(E){const t=E.cloneNode(!0);E.parentNode?.replaceChild(t,E),t.addEventListener("click",()=>{const e=t.getAttribute("data-share-token");if(e){const n=window.location.pathname.replace("/misas/","/misas/view/"),c=`${window.location.origin}${n}?share_token=${e}`;A(c,"¡Enlace copiado!","Compártelo con quien quieras.")}else console.error("No share token found"),a("Error","No se encontró el token para compartir.")})}const w=document.getElementById("copyEditorLinkBtn");if(w){const t=w.cloneNode(!0);w.parentNode?.replaceChild(t,w),t.addEventListener("click",()=>{const e=t.getAttribute("data-edit-token");if(console.log("Copy Editor Btn clicked. Token:",e),e){const n=`${window.location.origin}${window.location.pathname}?edit_token=${e}`;A(n,"¡Enlace de Editor copiado!","Ten cuidado con quién lo compartes.")}else console.error("No edit token found on button"),a("Error","No se encontró el token de edición.")})}const h=document.getElementById("editMisaBtn"),u=document.getElementById("editMisaModal"),f=document.getElementById("closeEditMisaModal"),b=document.getElementById("editMisaForm");if(h&&u&&f){const t=h.cloneNode(!0);h.parentNode?.replaceChild(t,h);const o=f.cloneNode(!0);f.parentNode?.replaceChild(o,f),t.addEventListener("click",()=>{u.classList.remove("hidden")}),o.addEventListener("click",()=>{u.classList.add("hidden")}),u.onclick=e=>{e.target===u&&u.classList.add("hidden")}}if(b){const t=b.cloneNode(!0);b.parentNode?.replaceChild(t,b),t.addEventListener("submit",async o=>{o.preventDefault();const e=o.target,n=new FormData(e),c=n.get("title")?.toString()||"",i=n.get("dateMisa")?.toString()||"",m=n.get("visibility")?.toString()||"",d=e.getAttribute("data-misa-id"),l=document.querySelector("main")?.getAttribute("data-token"),s=document.querySelector("main")?.getAttribute("data-edit-token");if(d&&(l||s)){const r=e.querySelector("button[type='submit']"),N=r?r.textContent:"Guardar";r&&(r.setAttribute("disabled","true"),r.textContent="Guardando...");try{console.log("Calling updateMisa...");const g=await F(parseInt(d),c,i,m,l||void 0,s||void 0);console.log("updateMisa result:",g),g.success?(console.log("Success, showing toast..."),await M("¡Actualizado!","Los datos de la misa se han guardado"),console.log("Toast shown, reloading..."),window.location.reload()):(a("Error",g.error||"Error al actualizar"),r&&(r.removeAttribute("disabled"),r.textContent=N))}catch(g){console.error(g),a("Error","Error de conexión"),r&&(r.removeAttribute("disabled"),r.textContent=N)}}})}const y=document.getElementById("deleteMisaBtn");if(y){const t=y.cloneNode(!0);y.parentNode?.replaceChild(t,y),t.addEventListener("click",async()=>{const e=document.getElementById("editMisaForm")?.getAttribute("data-misa-id"),n=document.querySelector("main")?.getAttribute("data-token");if(!e||!n)return;if((await L("¿Eliminar misa?","Esta acción no se puede deshacer.","Sí, eliminar")).isConfirmed){B("Eliminando...");try{const i=await D(parseInt(e),n);i.success?(await M("Misa eliminada",void 0,1500),window.location.href="/misas"):a("Error",i.error||"Error al eliminar")}catch{a("Error","Error de conexión")}}})}};document.addEventListener("DOMContentLoaded",I);document.addEventListener("astro:page-load",I);const S=document.getElementById("shareMisaBtn");S&&S.addEventListener("click",async()=>{const k=window.location.href,C=document.title;if(navigator.share)try{await navigator.share({title:C,url:k})}catch(p){console.error("Error sharing:",p)}else try{await navigator.clipboard.writeText(k),alert("Enlace copiado al portapapeles")}catch(p){console.error("Failed to copy:",p)}});const T=document.getElementById("cloneMisaForm"),v=document.getElementById("cloneMisaBtn");T&&v&&T.addEventListener("submit",()=>{v.disabled=!0,v.innerHTML=`
                <svg class="animate-spin -ml-1 mr-2 h-3 w-3 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Clonando...
             `,v.classList.add("opacity-50","cursor-not-allowed")});
