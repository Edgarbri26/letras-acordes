const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/ai.DExD9l2T.js","_astro/songs.DRRN3sIx.js"])))=>i.map(i=>d[i]);
import{_ as T}from"./preload-helper.BlTxHScW.js";import{S as p}from"./sweetalert2.esm.all.BbQndx0i.js";const A={background:"#1f2937",color:"#fff",confirmButtonColor:"#f97316",cancelButtonColor:"#4b5563"},w=(c,i)=>p.fire({...A,icon:"error",title:c,text:i}),_=(c,i,E=3e3)=>p.fire({...A,icon:"success",title:c,text:i,toast:!0,position:"top-end",showConfirmButton:!1,timer:E}),R=(c,i,E="Sí",h="Cancelar")=>p.fire({...A,title:c,text:i,icon:"warning",showCancelButton:!0,confirmButtonText:E,cancelButtonText:h,reverseButtons:!0}),D=c=>p.fire({...A,title:c,allowOutsideClick:!1,didOpen:()=>{p.showLoading()}});console.log("Script starting in add.astro");document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("add-song-data"),i=c?.dataset.apiUrl,E=c?.dataset.errorMessage,h=c?.dataset.token;E&&console.error("Error Message:",E),console.log("Initializing category logic...");const C=document.querySelector("#btn-new-category"),u=document.querySelector("#modal-category"),S=document.querySelector("#btn-save-category"),b=document.querySelector("#new-cat-name"),x=document.querySelector("#categoryId"),P=document.querySelector("#modal-category button[value='cancel']");console.log("btnNewCategory:",C),console.log("modalCategory:",u),C&&u?(console.log("Adding click listener to btnNewCategory"),C.addEventListener("click",e=>{console.log("btnNewCategory clicked"),e.preventDefault(),u.showModal(),b&&(b.value="",b.focus())})):console.error("Elements not found:",{btnNewCategory:C,modalCategory:u}),P&&u&&P.addEventListener("click",e=>{e.preventDefault(),u.close()}),S&&S.addEventListener("click",async()=>{const e=b?.value.trim();if(e)try{if(S.disabled=!0,S.textContent="Guardando...",!i)throw new Error("API URL not found");const o={"Content-Type":"application/json"};h&&(o.Authorization=`Bearer ${h}`);const l=await fetch(`${i}/categories`,{method:"POST",headers:o,body:JSON.stringify({name:e})});if(l.ok){const n=await l.json(),r=document.createElement("option");r.value=n.id,r.textContent=n.name,r.selected=!0,x?.appendChild(r),u?.close(),console.log("¡Categoría creada!")}else{const n=await l.json();console.error("Error al crear la categoría",n)}}catch(o){console.error(o),console.error("Error de conexión")}finally{S.disabled=!1,S.textContent="Guardar"}});const L=document.querySelector("main form"),k=L?.querySelector("button[type='submit']");L&&L.addEventListener("submit",()=>{k&&(k.setAttribute("disabled","true"),k.innerHTML="Guardando...",k.classList.add("opacity-75","cursor-not-allowed"))});const m=document.getElementById("btn-ai-autocomplete");console.log("Searching for AI button...",m),m&&m.addEventListener("click",async()=>{console.log("AI Button Clicked");const e=document.querySelector("#title"),o=document.querySelector("#key"),l=document.querySelector('[name="content"]');console.log("Inputs found:",{title:!!e,key:!!o,content:!!l});const n=e?.value||"",r=o?.value||"",s=l?.value||"";if(!n||!r||!s){console.error("Datos incompletos"),await w("Datos incompletos","Por favor completa el título, tono y letra antes de generar acordes.");return}if((await R("¿Generar acordes con IA?","Esto agregará acordes a la letra actual. El contenido del editor será reemplazado con la versión que incluye acordes.","Sí, generar","Cancelar")).isConfirmed){console.log("--- AI Autocomplete Context ---"),console.log("Title:",n),console.log("Key:",r),console.log("Content:",s),console.log("-------------------------------");try{D("Generando acordes con IA..."),m.disabled=!0,m.classList.add("opacity-75","cursor-not-allowed");const{autocompleteChordsWithAI:f}=await T(async()=>{const{autocompleteChordsWithAI:d}=await import("./ai.DExD9l2T.js");return{autocompleteChordsWithAI:d}},__vite__mapDeps([0,1])),y=await f({title:n,tone:r,lyrics:s},h,i);if(!y.success)throw new Error(y.error||"Error al generar acordes");const v=y.data;if(console.log("AI Response:",v),v&&v.chordPro){window.dispatchEvent(new CustomEvent("update-editor-content",{detail:{content:v.chordPro}}));const d=v.chords?.list?.join(", ")||"N/A";await _("¡Acordes generados!",`${v.chords?.count||0} acordes únicos: ${d}`,5e3)}else throw new Error("Respuesta inválida del servidor")}catch(f){console.error("Error al generar acordes:",f);const y=f instanceof Error?f.message:"Error desconocido";await w("Error al generar acordes",`${y}

Por favor intenta nuevamente. Si el problema persiste, verifica tu conexión a internet.`)}finally{p.close(),m.disabled=!1,m.classList.remove("opacity-75","cursor-not-allowed")}}});const g=document.getElementById("btn-ai-search-song");console.log("Searching for AI Search Song button...",g),g&&g.addEventListener("click",async()=>{console.log("AI Search Song Button Clicked");const e=document.querySelector("#title"),o=document.querySelector("#artist"),l=document.querySelector('[name="content"]'),n=e?.value||"",r=o?.value||"",s=l?.value||"";if(!s||s.trim().length===0){await w("Fragmento de letra requerido",`Por favor escribe al menos 2-4 líneas de la letra de la canción que deseas buscar.

Ejemplo:
'Santo, santo, santo es el Señor
Dios del universo
Llenos están el cielo y la tierra'`);return}if(s.trim().length<50){await w("Fragmento muy corto",`El fragmento de letra es demasiado corto para identificar la canción.

Por favor escribe al menos 2-4 líneas completas de la letra.

Ejemplo:
'Santo, santo, santo es el Señor
Dios del universo
Llenos están el cielo y la tierra'`);return}const $=r?` de ${r}`:"",f=n?` (${n})`:"",y=s.substring(0,100);if((await R("¿Buscar canción por letra?",`Se buscará la canción original usando este fragmento${f}${$}:

"${y}${s.length>100?"...":""}"

El contenido actual del editor será reemplazado con la canción completa encontrada.`,"Sí, buscar","Cancelar")).isConfirmed){console.log("--- AI Search Song Context ---"),console.log("Lyric Fragment:",s),console.log("Title (hint):",n),console.log("Artist (hint):",r),console.log("-------------------------------");try{D("Buscando canción..."),g.disabled=!0,g.classList.add("opacity-75","cursor-not-allowed");const{searchSongByLyrics:d}=await T(async()=>{const{searchSongByLyrics:I}=await import("./ai.DExD9l2T.js");return{searchSongByLyrics:I}},__vite__mapDeps([0,1])),a=await d({lyricFragment:s,artist:r||void 0,title:n||void 0},h,i);if(!a.success)throw new Error(a.error||"Error al buscar la canción");const t=a.data;if(console.log("AI Search Song Response:",t),t&&t.chordPro){if(t.metadata?.title&&e&&(e.value=t.metadata.title),t.metadata?.artist&&o&&(o.value=t.metadata.artist),t.metadata?.key){const N=document.querySelector("#key");N&&(N.value=t.metadata.key,window.dispatchEvent(new CustomEvent("song-key-change",{detail:{key:t.metadata.key}})))}window.dispatchEvent(new CustomEvent("update-editor-content",{detail:{content:t.chordPro}}));const I=t.chords?.list?.join(", ")||"N/A",q=t.metadata?.title||"Canción",M=t.metadata?.artist||"Desconocido";await _("¡Canción encontrada!",`${q} - ${M} (${t.metadata?.key||"N/A"}) | ${t.chords?.count||0} acordes`,6e3)}else throw new Error("Respuesta inválida del servidor")}catch(d){console.error("Error al buscar canción:",d);const a=d instanceof Error?d.message:"Error desconocido",t=a.includes("No se pudo identificar")||a.includes("no encontr"),I=a.includes("timeout")||a.includes("ECONNABORTED")||a.includes("Network Error"),q=a.includes("500")||a.includes("502")||a.includes("503");t?await w("Canción no identificada",`No se pudo identificar la canción con el fragmento proporcionado.

Intenta con:
• Un fragmento más largo (4-6 líneas)
• Frases más distintivas de la canción
• Agregar el nombre del artista como pista`):I||q?await w("Servicio de IA no disponible",`El servicio de inteligencia artificial no está respondiendo en este momento.

Posibles causas:
• El servicio puede estar temporalmente caído
• Problemas de conexión a internet
• El servidor está sobrecargado

Por favor intenta nuevamente en unos minutos.`):await w("Error al buscar la canción",`${a}

Por favor verifica tu conexión a internet e intenta nuevamente.`)}finally{p.close(),g.disabled=!1,g.classList.remove("opacity-75","cursor-not-allowed")}}});const B=document.querySelector("#key");B?.addEventListener("change",e=>{if(e.target instanceof HTMLSelectElement){const o=e.target.value,l=new CustomEvent("song-key-change",{detail:{key:o}});window.dispatchEvent(l)}}),window.addEventListener("editor-key-change",e=>{e instanceof CustomEvent&&B&&e.detail&&e.detail.key&&(B.value=e.detail.key)})});
