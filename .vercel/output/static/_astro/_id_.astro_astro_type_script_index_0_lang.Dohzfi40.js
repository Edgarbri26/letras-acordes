import{u as M,r as A,b as S,d as B}from"./misas.DM9YAX4E.js";import{d as f,b as i,s as h,a as p}from"./alerts.B2mnkYRv.js";import{S as L}from"./sweetalert2.esm.all.BbQndx0i.js";import"./songs.DRRN3sIx.js";document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('button[data-action="edit-tone"]').forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const n=t.getAttribute("data-current-tone"),d=Number(t.getAttribute("data-misa-id")),r=Number(t.getAttribute("data-misa-song-id")),s=document.querySelector("main")?.getAttribute("data-token"),c=document.querySelector("main")?.getAttribute("data-edit-token"),{value:a}=await L.fire({title:"Cambiar Tono",input:"text",inputLabel:"Nuevo tono (ej: Do, Re, Mim)",inputValue:n||"",showCancelButton:!0,confirmButtonColor:"#f97316",cancelButtonColor:"#4b5563",confirmButtonText:"Guardar",background:"#1f2937",color:"#fff",inputValidator:o=>{if(!o)return"Debes escribir un tono"}});if(a&&a!==n){f("Actualizando...");try{const o=await M(d,r,a,s||void 0,c||void 0);o.success?window.location.reload():i("Error",o.error||"No se pudo actualizar el tono.")}catch{i("Error","Error de conexión.")}}})}),document.querySelectorAll(".add-song-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-moment-id");window.openAddSongModal&&e?window.openAddSongModal(e):i("Error","El gestor de canciones no está cargado. Intenta recargar la página.")})}),document.querySelectorAll('button[data-action="delete-song"]').forEach(t=>{t.addEventListener("click",async e=>{if(e.preventDefault(),!(await h("¿Eliminar canción?","No podrás deshacer esta acción","Sí, eliminar")).isConfirmed)return;const d=Number(t.getAttribute("data-misa-id")),r=Number(t.getAttribute("data-misa-song-id")),s=document.querySelector("main")?.getAttribute("data-token"),c=document.querySelector("main")?.getAttribute("data-edit-token");if(d&&r&&(s||c)){f("Eliminando...");try{const a=await A(d,r,s||void 0,c||void 0);a.success?window.location.reload():i("Error",a.error||"Error al eliminar.")}catch{i("Error","Error de conexión.")}}})});const b=async(t,e,n)=>{try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t),p(e,n);else throw new Error("Clipboard API not available")}catch(d){console.error("Error al copiar",d),i("Error","No se pudo copiar el enlace. Intenta hacerlo manualmente.")}},g=document.getElementById("copyShareLinkBtn");g&&g.addEventListener("click",()=>{const t=g.getAttribute("data-share-token");if(t){const e=window.location.pathname.replace("/misas/","/misas/view/"),n=`${window.location.origin}${e}?share_token=${t}`;b(n,"¡Enlace copiado!","Compártelo con quien quieras.")}else console.error("No share token found"),i("Error","No se encontró el token para compartir.")});const E=document.getElementById("copyEditorLinkBtn");E&&E.addEventListener("click",()=>{const t=E.getAttribute("data-edit-token");if(console.log("Copy Editor Btn clicked. Token:",t),t){const e=`${window.location.origin}${window.location.pathname}?edit_token=${t}`;b(e,"¡Enlace de Editor copiado!","Ten cuidado con quién lo compartes.")}else console.error("No edit token found on button"),i("Error","No se encontró el token de edición.")});const w=document.getElementById("editMisaBtn"),l=document.getElementById("editMisaModal"),k=document.getElementById("closeEditMisaModal"),u=document.getElementById("editMisaForm");w&&l&&k&&(w.addEventListener("click",()=>{l.classList.remove("hidden")}),k.addEventListener("click",()=>{l.classList.add("hidden")}),l.addEventListener("click",t=>{t.target===l&&l.classList.add("hidden")})),u&&u.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(u),n=e.get("title")?.toString()||"",d=e.get("dateMisa")?.toString()||"",r=e.get("visibility")?.toString()||"",s=u.getAttribute("data-misa-id"),c=document.querySelector("main")?.getAttribute("data-token"),a=document.querySelector("main")?.getAttribute("data-edit-token");if(s&&(c||a)){const o=u.querySelector("button[type='submit']"),v=o?o.textContent:"Guardar";o&&(o.setAttribute("disabled","true"),o.textContent="Guardando...");try{console.log("Calling updateMisa...");const m=await S(parseInt(s),n,d,r,c||void 0,a||void 0);console.log("updateMisa result:",m),m.success?(console.log("Success, showing toast..."),await p("¡Actualizado!","Los datos de la misa se han guardado"),console.log("Toast shown, reloading..."),window.location.reload()):(i("Error",m.error||"Error al actualizar"),o&&(o.removeAttribute("disabled"),o.textContent=v))}catch(m){console.error(m),i("Error","Error de conexión"),o&&(o.removeAttribute("disabled"),o.textContent=v)}}});const y=document.getElementById("deleteMisaBtn");y&&y.addEventListener("click",async()=>{const e=document.getElementById("editMisaForm")?.getAttribute("data-misa-id"),n=document.querySelector("main")?.getAttribute("data-token");if(!e||!n)return;if((await h("¿Eliminar misa?","Esta acción no se puede deshacer.","Sí, eliminar")).isConfirmed){f("Eliminando...");try{const r=await B(parseInt(e),n);r.success?(await p("Misa eliminada",void 0,1500),window.location.href="/misas"):i("Error",r.error||"Error al eliminar")}catch{i("Error","Error de conexión")}}})});
