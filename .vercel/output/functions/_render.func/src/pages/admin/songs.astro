---
import AdminLayout from "../../layouts/AdminLayout.astro";
import type { Song } from "../../types/song";
import { API_URL } from "@/services/songs";

const token = Astro.cookies.get("token")?.value;

if (!token) {
    return Astro.redirect("/login");
}

let songs = [];
let error = null;

try {
    const res = await fetch(`${API_URL}/songs?active=all`, {
        headers: {
            Authorization: `Bearer ${token}`,
        },
    });
    if (res.ok) {
        songs = await res.json();
    } else {
        throw new Error("Error cargando canciones");
    }
} catch (e) {
    console.error(e);
    error = "No se pudieron cargar las canciones";
}
---

<AdminLayout title="Gestión de Canciones">
    <div id="songs-page" class="p-6" data-api-url={API_URL} data-token={token}>
        <div
            class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4"
        >
            <h1 class="text-3xl font-bold text-accent-main">
                Gestión de Canciones
            </h1>

            <div class="flex gap-4 items-center">
                <select
                    id="statusFilter"
                    class="bg-bg-secondary border border-white/10 rounded-lg px-4 py-2 text-text-main focus:outline-none focus:border-accent-main cursor-pointer"
                >
                    <option value="all">Todas</option>
                    <option value="true">Activas</option>
                    <option value="false">Inactivas</option>
                </select>

                <a
                    href="/add-song"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center gap-2"
                >
                    <i class="fa-solid fa-plus-circle"></i>
                    Nueva Canción
                </a>
            </div>
        </div>

        {
            error && (
                <div class="bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded mb-6">
                    {error}
                </div>
            )
        }

        <div
            class="overflow-x-auto bg-bg-secondary rounded-lg border border-white/10"
        >
            <table class="w-full text-left text-sm text-text-main">
                <thead class="bg-bg-main text-text-secondary uppercase">
                    <tr>
                        <th class="px-6 py-3 border-b border-white/10">ID</th>
                        <th class="px-6 py-3 border-b border-white/10"
                            >Título</th
                        >
                        <th class="px-6 py-3 border-b border-white/10"
                            >Artista</th
                        >
                        <th
                            class="px-6 py-3 border-b border-white/10 text-center"
                            >Estado</th
                        >
                        <th
                            class="px-6 py-3 border-b border-white/10 text-center"
                            >Acciones</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {
                        songs.map((song: any) => (
                            <tr
                                class="hover:bg-white/5 transition-colors song-row"
                                data-active={song.active.toString()}
                            >
                                <td class="px-6 py-4">{song.id}</td>
                                <td class="px-6 py-4 font-medium">
                                    {song.title}
                                </td>
                                <td class="px-6 py-4 text-text-secondary">
                                    {song.artist}
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input
                                            type="checkbox"
                                            class="sr-only peer toggle-active"
                                            value=""
                                            checked={song.active}
                                            data-id={song.id}
                                        />
                                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent-main/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-main" />
                                        <span class="ml-3 text-sm font-medium text-gray-300">
                                            {song.active
                                                ? "Activo"
                                                : "Inactivo"}
                                        </span>
                                    </label>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex items-center justify-center gap-3">
                                        <a
                                            href={`/edit-song/${song.id}`}
                                            class="text-blue-400 hover:text-blue-300 transition-colors"
                                            title="Editar"
                                        >
                                            <i class="fa-solid fa-pen-to-square h-5 w-5" />
                                        </a>
                                        <button
                                            class="text-red-400 hover:text-red-300 transition-colors delete-song-btn"
                                            data-id={song.id}
                                            title="Eliminar permanentemente"
                                        >
                                            <i class="fa-solid fa-trash h-5 w-5" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>
    </div>
</AdminLayout>

<script>
    import Swal from "sweetalert2";

    const pageContainer = document.getElementById("songs-page");
    const API_URL = pageContainer?.dataset.apiUrl;
    const token = pageContainer?.dataset.token;

    const toggles = document.querySelectorAll(".toggle-active");
    const deleteBtns = document.querySelectorAll(".delete-song-btn");
    const filterSelect = document.getElementById("statusFilter");
    const songRows = document.querySelectorAll(".song-row");

    // Filter Logic
    filterSelect?.addEventListener("change", (e) => {
        if (!(e.target instanceof HTMLSelectElement)) return;
        const filter = e.target.value;
        songRows.forEach((row) => {
            if (!(row instanceof HTMLElement)) return;
            const rowActive = row.dataset.active;
            if (filter === "all" || rowActive === filter) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });

    const swalDark = {
        background: "#1f2937",
        color: "#fff",
        confirmButtonColor: "#f97316",
        cancelButtonColor: "#4b5563",
    };

    // Toggle Active Status
    toggles.forEach((toggle) => {
        toggle.addEventListener("change", async (e) => {
            if (!(e.target instanceof HTMLInputElement)) return;
            const id = e.target.dataset.id;
            const isActive = e.target.checked;
            const labelSpan = e.target.parentElement?.querySelector("span");

            try {
                // Optimistic UI update
                if (labelSpan)
                    labelSpan.textContent = isActive ? "Activo" : "Inactivo";

                const res = await fetch(`${API_URL}/songs/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ active: isActive }),
                });

                if (!res.ok) throw new Error("Error updating status");

                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    ...swalDark,
                });
                Toast.fire({
                    icon: "success",
                    title: `Canción ${isActive ? "activada" : "desactivada"}`,
                });
            } catch (error) {
                console.error(error);
                e.target.checked = !isActive; // Revert
                if (labelSpan)
                    labelSpan.textContent = !isActive ? "Activo" : "Inactivo";
                Swal.fire({
                    ...swalDark,
                    icon: "error",
                    title: "Error",
                    text: "No se pudo actualizar el estado",
                });
            }
        });
    });

    // Delete Song
    deleteBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            if (!(btn instanceof HTMLElement)) return;
            const id = btn.dataset.id;
            Swal.fire({
                ...swalDark,
                title: "¿Estás seguro?",
                text: "Esta acción eliminará la canción permanentemente.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar",
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`${API_URL}/songs/${id}`, {
                            method: "DELETE",
                            headers: {
                                Authorization: `Bearer ${token}`,
                            },
                        });

                        if (res.ok) {
                            Swal.fire({
                                ...swalDark,
                                icon: "success",
                                title: "Eliminado",
                                text: "La canción ha sido eliminada.",
                            }).then(() => window.location.reload());
                        } else {
                            throw new Error("Error deleting song");
                        }
                    } catch (e) {
                        Swal.fire({
                            ...swalDark,
                            icon: "error",
                            title: "Error",
                            text: "No se pudo eliminar la canción",
                        });
                    }
                }
            });
        });
    });
</script>
