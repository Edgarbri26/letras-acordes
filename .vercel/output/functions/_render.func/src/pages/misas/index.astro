---
// export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import { getMisas } from "../../services/misas";

const { success, data: misas } = await getMisas();

// Filter misas
const today = new Date();
today.setHours(0, 0, 0, 0);

const misasVigentes = misas?.filter((m) => new Date(m.dateMisa) >= today) || [];
const misasPasadas = misas?.filter((m) => new Date(m.dateMisa) < today) || [];

// Helper to format date
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};
---

<Layout title="Misas - CancioneroDigital">
    <main class="max-w-4xl mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
                Misas
            </h1>
            <a
                href="/misas/add"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
            >
                + Nueva Misa
            </a>
        </div>

        {
            misasVigentes.length > 0 && (
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-green-600 dark:text-green-400">
                        PrÃ³ximas Misas
                    </h2>
                    <div class="grid gap-4">
                        {misasVigentes.map((misa) => (
                            <a
                                href={`/misas/${misa.id}`}
                                class="block bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-md transition border border-gray-200 dark:border-gray-700"
                            >
                                <h3 class="text-xl font-bold mb-2">
                                    {misa.title}
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400">
                                    ðŸ“… {formatDate(misa.dateMisa)}
                                </p>
                                <p class="text-sm text-gray-500 mt-2">
                                    {misa.misaSongs.length} canciones
                                </p>
                            </a>
                        ))}
                    </div>
                </section>
            )
        }

        {
            misasPasadas.length > 0 && (
                <section>
                    <h2 class="text-2xl font-semibold mb-4 text-gray-500">
                        Misas Anteriores
                    </h2>
                    <div class="grid gap-4 opacity-75">
                        {misasPasadas.map((misa) => (
                            <a
                                href={`/misas/${misa.id}`}
                                class="block bg-gray-50 dark:bg-gray-900 p-6 rounded-lg border border-gray-200 dark:border-gray-800 hover:bg-white dark:hover:bg-gray-800 transition"
                            >
                                <h3 class="text-lg font-bold mb-1">
                                    {misa.title}
                                </h3>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">
                                    ðŸ“… {formatDate(misa.dateMisa)}
                                </p>
                            </a>
                        ))}
                    </div>
                </section>
            )
        }

        {
            (!misas || misas.length === 0) && (
                <p class="text-center text-gray-500">
                    No hay misas registradas.
                </p>
            )
        }
    </main>
</Layout>
