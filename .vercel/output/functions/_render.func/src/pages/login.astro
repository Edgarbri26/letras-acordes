---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";

import { login } from "../services/auth";

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const email = data.get("email");
        const password = data.get("password");

        const response = await login(email, password);

        if (response && response.ok) {
            // Forward cookies from backend to client
            const setCookie = response.headers.get("set-cookie");
            if (setCookie) {
                // Logic to handle cookies if needed, or rely on client-side
            }
        }
    } catch (error) {
        console.error(error);
    }
}
---

<Layout title="Iniciar Sesión - Cancionero">
    <div
        class="flex flex-col min-h-screen bg-bg-main text-text-main items-center justify-center p-4"
    >
        <div
            class="w-full max-w-md bg-bg-secondary p-8 rounded-xl shadow-lg border border-white/5"
        >
            <h1 class="text-2xl font-bold text-accent-main mb-6 text-center">
                Iniciar Sesión
            </h1>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Correo Electrónico</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="admin@example.com"
                    />
                </div>

                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Contraseña</label
                    >
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="••••••••"
                    />
                </div>

                <div
                    id="errorMessage"
                    class="text-red-500 text-sm text-center hidden"
                >
                </div>

                <button
                    type="submit"
                    form="loginForm"
                    
                    class="w-full bg-accent-main text-white font-bold py-3 rounded-lg hover:bg-accent-secondary transition-transform transform active:scale-95"
                >
                    Ingresar
                </button>
            </form>
        </div>
    </div>
</Layout>

<script>
    import { login } from "../services/auth";

    const form = document.getElementById("loginForm");
    const errorMessage = document.getElementById("errorMessage");

    if (form instanceof HTMLFormElement && errorMessage) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const email = formData.get("email");
            const password = formData.get("password");

            try {
                const res = await login(email, password);

                if (res && res.ok) {
                    // If backend sets cookie successfully, we just redirect
                    window.location.href = "/";
                } else {
                    const error = res
                        ? await res.json()
                        : { error: "Error desconocido" };
                    errorMessage.textContent =
                        error.error || "Error al iniciar sesión";
                    errorMessage.classList.remove("hidden");
                }
            } catch (err) {
                console.error(err);
                errorMessage.textContent = "Error de conexión";
                errorMessage.classList.remove("hidden");
            }
        });
    }
</script>
