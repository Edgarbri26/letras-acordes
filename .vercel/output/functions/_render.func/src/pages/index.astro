---
// export const prerender = false;
Astro.response.headers.set(
	"Cache-Control",
	"no-cache, no-store, must-revalidate",
);
import Layout from "@/layouts/Layout.astro";
import "../styles/global.css";

import type { Song } from "@/types/song";
import type { Category } from "@/types/category";
import { getUserFromToken } from "@/utils/auth";
import { API_URL } from "@/services/songs";
import GridSongs from "@/components/GridSongs.jsx";
import CategoryFilter from "@/components/CategoryFilter.jsx";
import DashboardStats from "@/components/DashboardStats.jsx";

// let songs: Song[] = []; // Removed server-side fetching
// let categories: Category[] = []; // Removed server-side fetching
interface Stats {
	totalSongs: number;
	totalCategories: number;
	activeSongs?: number;
}
let stats: Stats = { totalSongs: 0, totalCategories: 0, activeSongs: 0 };
let error = null;

const token = Astro.cookies.get("token")?.value;
const headers: Record<string, string> = token
	? { Authorization: `Bearer ${token}` }
	: {};

const user = getUserFromToken(token);

// try {
// 	// Fetch stats
// 	const statsRes = await fetch(`${API_URL}/stats`, { headers });
// 	if (statsRes.ok) {
// 		stats = await statsRes.json();
// 	}
// } catch (e) {
// 	if (e instanceof Error) {
// 		error = e.message;
// 	} else {
// 		error = String(e);
// 		console.error("Error fetching songs:", error);
// 	}
// }

const seoTitle = "Cancionero Digital | Letras y Acordes Católicos";
const seoDescription =
	"Mi canciónero el mejor cancionero digital para músicos católicos. Encuentra letras, acordes y herramientas de transposición para tu ministerio de música. Ademas crear tus misas con tus canciones favoritas.";

const schema = {
	"@context": "https://schema.org",
	"@type": "WebSite",
	name: "Cancionero Digital",
	url: Astro.url.origin,
	description: seoDescription,
	potentialAction: {
		"@type": "SearchAction",
		target: `${Astro.url.origin}/search/all?q={search_term_string}`,
		"query-input": "required name=search_term_string",
	},
};
---

<Layout title={seoTitle} description={seoDescription}>
	<script
		type="application/ld+json"
		slot="head"
		set:html={JSON.stringify(schema)}
	/>
	<div class="flex flex-col h-fullbg-bg-main text-text-main">
		<main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
			<!-- Dashboard Stats -->
			<section class="mb-12">
				<h1 class="text-3xl font-bold text-accent-main mb-6">
					Panel Principal
				</h1>
				<DashboardStats client:load isAdmin={user?.role === "ADMIN"} />
			</section>

			<section>
				<div class="flex items-center justify-between mb-8">
					<h2 class="text-2xl font-bold text-white">
						Últimas Agregadas
					</h2>
					<a
						href="/songs/search/all"
						class="text-sm font-medium text-accent-main hover:text-white transition-colors"
						data-astro-prefetch
					>
						Ver todas →
					</a>
				</div>

				<CategoryFilter client:load isAdmin={user?.role === "ADMIN"} />

				<GridSongs client:load endpoint={`${API_URL}/songs?limit=12`} />
			</section>
		</main>
	</div>
</Layout>
