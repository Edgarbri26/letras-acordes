---
import { getUserFromToken, hasPermission } from "../utils/auth";
const { id } = Astro.props;
const token = Astro.cookies.get("token")?.value;
const user = getUserFromToken(token);
const canEditSong = hasPermission(user, "song.edit");
---

<aside
    id="song-tools-aside"
    class="w-16 flex flex-col items-center py-4 gap-4 sticky top-16 h-[calc(100vh-4rem)] border-r border-white/5 md:flex no-print transition-all duration-300 ease-in-out overflow-visible z-40 bg-bg-main"
>
    <!-- Toggle Button -->
    <button
        id="btn-toggle-tools"
        class="p-2 text-text-secondary hover:text-accent-main transition-all duration-300 absolute right-1/2 translate-x-1/2 top-4 z-50 bg-bg-main rounded-full"
        title="Ocultar herramientas"
    >
        <i
            class="fa-solid fa-arrow-left transition-transform duration-300"
            id="icon-toggle"></i>
    </button>

    <!-- Tools Container -->
    <div
        id="tools-content"
        class="flex flex-col items-center gap-4 mt-12 w-full opacity-100 transition-opacity duration-300 overflow-hidden"
    >
        {/* Botones de Tono */}
        <div
            class="flex flex-col gap-2 w-full px-2 items-center md:items-stretch"
        >
            <button
                id="btn-transpose-up"
                class="flex items-center justify-center md:justify-start gap-3 p-2 text-text-secondary hover:text-accent-main transition font-bold rounded-lg hover:bg-white/5 w-full"
                title="Subir Tono"
            >
                <i
                    class="fa-solid fa-plus w-5 h-5 flex items-center justify-center"
                ></i>
                <span
                    class="tool-label hidden md:block whitespace-nowrap opacity-0 w-0 overflow-hidden transition-all duration-300"
                    >Subir Tono</span
                >
            </button>

            <span class="text-xs text-text-secondary md:hidden mb-1">Tono</span>

            <button
                id="btn-transpose-down"
                class="flex items-center justify-center md:justify-start gap-3 p-2 text-text-secondary hover:text-accent-main transition font-bold rounded-lg hover:bg-white/5 w-full"
                title="Bajar Tono"
            >
                <i
                    class="fa-solid fa-minus w-5 h-5 flex items-center justify-center"
                ></i>
                <span
                    class="tool-label hidden md:block whitespace-nowrap opacity-0 w-0 overflow-hidden transition-all duration-300"
                    >Bajar Tono</span
                >
            </button>
        </div>

        <div class="h-px w-8 bg-white/10 my-1"></div>

        <button
            id="btn-toggle-chords"
            class="flex items-center justify-center md:justify-start gap-3 p-2 text-text-secondary hover:text-accent-main transition rounded-lg hover:bg-white/5 w-[calc(100%-1rem)]"
            title="Alternar Acordes"
        >
            <i
                class="fa-solid fa-music w-5 h-5 flex items-center justify-center"
            ></i>
            <span
                class="tool-label hidden md:block whitespace-nowrap opacity-0 w-0 overflow-hidden transition-all duration-300"
                >Acordes</span
            >
        </button>

        <div class="h-px w-8 bg-white/10 my-1"></div>
        <button
            id="btn-print"
            class="flex items-center justify-center md:justify-start gap-3 p-2 text-text-secondary hover:text-accent-main transition rounded-lg hover:bg-white/5 w-[calc(100%-1rem)]"
            title="Descargar"
        >
            <i
                class="fa-solid fa-download w-5 h-5 flex items-center justify-center"
            ></i>
            <span
                class="tool-label hidden md:block whitespace-nowrap opacity-0 w-0 overflow-hidden transition-all duration-300"
                >Descargar</span
            >
        </button>

        {
            canEditSong && (
                <a
                    href={`/songs/edit/${id}`}
                    class="flex items-center justify-center md:justify-start gap-3 p-2 text-text-secondary hover:text-accent-main transition rounded-lg hover:bg-white/5 w-[calc(100%-1rem)]"
                    title="Editar"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="lucide lucide-pencil"
                    >
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                        <path d="m15 5 4 4" />
                    </svg>
                    <span class="tool-label hidden md:block whitespace-nowrap opacity-0 w-0 overflow-hidden transition-all duration-300">
                        Editar
                    </span>
                </a>
            )
        }
    </div>
</aside>

<script>
    const btnUp = document.getElementById("btn-transpose-up");
    const btnDown = document.getElementById("btn-transpose-down");
    const btnToggleChords = document.getElementById("btn-toggle-chords");
    const btnPrint = document.getElementById("btn-print");

    // Toggle Logic
    const aside = document.getElementById("song-tools-aside");
    const btnToggle = document.getElementById("btn-toggle-tools");
    const iconToggle = document.getElementById("icon-toggle");
    const toolsContent = document.getElementById("tools-content");

    let isCollapsed = false; // "isCollapsed" implies NON-DEFAULT state.
    // Mobile Default: Shown (isCollapsed=false).
    // Desktop Default: Compact (isCollapsed=false).

    // Initial Setup
    // Mobile Default: Shown (isCollapsed=false).
    // Desktop Default: Expanded (isCollapsed=true in this logic).

    const isDesktop = window.innerWidth >= 768;

    if (isDesktop) {
        isCollapsed = true;

        // Apply Expanded Styles Immediately
        aside?.classList.remove("w-16");
        aside?.classList.add("w-56");

        // Arrow points Left by default (which means "Collapse"), so NO rotation needed.

        // Show labels
        const labels = document.querySelectorAll(".tool-label");
        labels.forEach((el) => {
            el.classList.remove("opacity-0", "w-0", "hidden");
            el.classList.add("opacity-100", "w-auto");
        });
    } else {
        // Mobile: Default is Shown (w-16). Arrow points Left (Hide).
        // No changes needed to HTML defaults.
    }

    btnToggle?.addEventListener("click", () => {
        const isMobile = window.innerWidth < 768;

        isCollapsed = !isCollapsed;

        if (isMobile) {
            // ----- MOBILE BEHAVIOR (Hide/Show) -----
            if (isCollapsed) {
                // Hide completely
                aside?.classList.remove("w-16", "border-r", "py-4");
                aside?.classList.add("w-0", "border-none", "p-0", "min-w-0");

                btnToggle.classList.remove(
                    "right-1/2",
                    "translate-x-1/2",
                    "bg-bg-main",
                );
                btnToggle.classList.add(
                    "left-2",
                    "bg-bg-secondary",
                    "shadow-lg",
                );
                iconToggle?.classList.add("rotate-180");
                toolsContent?.classList.add("opacity-0", "pointer-events-none");
            } else {
                // Show standard
                aside?.classList.add("w-16", "border-r", "py-4");
                aside?.classList.remove("w-0", "border-none", "p-0", "min-w-0");

                btnToggle.classList.add(
                    "right-1/2",
                    "translate-x-1/2",
                    "bg-bg-main",
                );
                btnToggle.classList.remove(
                    "left-2",
                    "bg-bg-secondary",
                    "shadow-lg",
                );
                iconToggle?.classList.remove("rotate-180");
                toolsContent?.classList.remove(
                    "opacity-0",
                    "pointer-events-none",
                );
            }
        } else {
            // ----- DESKTOP BEHAVIOR (Compact/Expanded) -----
            // isCollapsed here effectively means "Is Expanded" because we toggle it.
            // Let's redefine: user wants [Compact] <-> [Expanded].
            // Default is Compact (w-16). Click -> Expand (w-64).

            // If we treat "isCollapsed = true" as "Expanded Mode" for PC (inverted naming, but logic flow):

            const labels = document.querySelectorAll(".tool-label");

            if (isCollapsed) {
                // EXPAND SIDEBAR (w-64)
                aside?.classList.remove("w-16");
                aside?.classList.add("w-56"); // Expanded width

                // Rotate arrow to point left (indicating "close" to compact)
                // Default arrow points Left. So actually we want to rotate it when Compact?
                // Left arrow usually means "Go Back" or "Collapse Left".
                // If expanded, we want arrow to point LEFT to collapse it back.
                // Current icon is fa-arrow-left.
                iconToggle?.classList.remove("rotate-180"); // Keep pointing left

                // Show labels
                labels.forEach((el) => {
                    el.classList.remove("opacity-0", "w-0", "hidden");
                    el.classList.add("opacity-100", "w-auto");
                });
            } else {
                // COMPACT SIDEBAR (w-16)
                aside?.classList.add("w-16");
                aside?.classList.remove("w-56");

                // Rotate arrow to point Right (indicating "Expand")
                iconToggle?.classList.add("rotate-180");

                // Hide labels
                labels.forEach((el) => {
                    el.classList.add("opacity-0", "w-0");
                    el.classList.remove("opacity-100", "w-auto");
                    // Wait for transition to finish before hidden? css handles opactiy/width
                    setTimeout(() => el.classList.add("hidden"), 300); // sync with duration
                });
            }
        }
    });

    let lastScrollTop = 0;
    let scrollTimeout: any; // Timer handle

    const hideButton = () => {
        // Only auto-hide on mobile (width < 768px)
        if (window.innerWidth >= 768) return;

        if (btnToggle && isCollapsed) {
            btnToggle.classList.add(
                "-translate-x-full",
                "opacity-0",
                "pointer-events-none",
            );
        }
    };

    window.addEventListener("scroll", () => {
        if (!isCollapsed || !btnToggle) return;

        // Disable auto-hide logic on desktop
        if (window.innerWidth >= 768) {
            btnToggle.classList.remove(
                "-translate-x-full",
                "opacity-0",
                "pointer-events-none",
            );
            return;
        }

        // Clear existing timer on every scroll event
        clearTimeout(scrollTimeout);

        const currentScroll =
            window.pageYOffset || document.documentElement.scrollTop;

        if (currentScroll > lastScrollTop && currentScroll > 50) {
            // Scroll Down - Hide immediately
            hideButton();
        } else {
            // Scroll Up - Show
            btnToggle.classList.remove(
                "-translate-x-full",
                "opacity-0",
                "pointer-events-none",
            );

            // Restart timer to hide after inactivity (e.g., 3 seconds)
            scrollTimeout = setTimeout(hideButton, 3000);
        }

        lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    });

    const dispatchTranspose = (semitones: number) => {
        window.dispatchEvent(
            new CustomEvent("song-transpose", {
                detail: { semitones },
            }),
        );
    };

    btnUp?.addEventListener("click", () => dispatchTranspose(1));
    btnDown?.addEventListener("click", () => dispatchTranspose(-1));

    btnToggleChords?.addEventListener("click", () => {
        window.dispatchEvent(new CustomEvent("song-toggle-chords"));
    });

    btnPrint?.addEventListener("click", () => {
        window.print();
    });
</script>
