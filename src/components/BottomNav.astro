---
import { getUserFromToken, hasPermission } from "@/utils/auth";

const token = Astro.cookies.get("token")?.value;
const user = getUserFromToken(token);
const isLoggedIn = !!user;

const canCreateSong = hasPermission(user, "song.create");
const canViewAdmin = hasPermission(user, "view.admin");

const currentPath = Astro.url.pathname;

const isActive = (path: string) => {
    if (path === "/" && currentPath === "/") return true;
    if (path !== "/" && currentPath.startsWith(path)) return true;
    return false;
};
---

<nav
    class="md:hidden fixed bottom-0 left-0 w-full bg-bg-secondary border-t border-white/10 z-50 pb-safe"
>
    <div class="flex justify-around items-center h-16">
        <a
            href="/"
            class={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive("/") && currentPath === "/" ? "text-accent-main" : "text-text-secondary hover:text-text-main"}`}
        >
            <i class="fa-solid fa-home text-xl"></i>
            <span class="text-[10px] font-medium">Inicio</span>
        </a>

        <a
            href="/misas"
            class={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive("/misas") ? "text-accent-main" : "text-text-secondary hover:text-text-main"}`}
        >
            <i class="fa-solid fa-book text-xl"></i>
            <span class="text-[10px] font-medium">Misas</span>
        </a>

        {
            isLoggedIn && canCreateSong && (
                <a
                    href="/songs/add"
                    class="flex flex-col items-center justify-center w-full h-full -mt-6"
                >
                    <div
                        class={`flex items-center justify-center w-14 h-14 rounded-full shadow-lg ${isActive("/songs/add") ? "bg-accent-main text-white ring-4 ring-bg-secondary" : "bg-bg-main border border-white/10 text-accent-main"}`}
                    >
                        <i class="fa-solid fa-plus text-2xl" />
                    </div>
                </a>
            )
        }
        {
            !canViewAdmin && (
                <a
                    href="/songs/all"
                    class={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive("/songs/all") ? "text-accent-main" : "text-text-secondary hover:text-text-main"}`}
                >
                    <i class="fa-solid fa-music text-xl" />
                    <span class="text-[10px] font-medium">Canciones</span>
                </a>
            )
        }

        {
            isLoggedIn && canViewAdmin && (
                <a
                    href="/admin/users"
                    class={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive("/admin") ? "text-accent-main" : "text-text-secondary hover:text-text-main"}`}
                >
                    <i class="fa-solid fa-shield text-xl" />
                    <span class="text-[10px] font-medium">Admin</span>
                </a>
            )
        }

        {
            isLoggedIn ? (
                <a
                    href="/logout"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-secondary hover:text-red-400"
                >
                    <i class="fa-solid fa-arrow-right-from-bracket text-xl" />
                    <span class="text-[10px] font-medium">Salir</span>
                </a>
            ) : (
                <a
                    href="/login"
                    class={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive("/login") ? "text-accent-main" : "text-text-secondary hover:text-text-main"}`}
                >
                    <i class="fa-solid fa-user text-xl" />
                    <span class="text-[10px] font-medium">Ingresar</span>
                </a>
            )
        }
    </div>
</nav>

<style>
    .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
    }
</style>
