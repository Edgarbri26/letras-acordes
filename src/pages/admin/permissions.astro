---
import AdminLayout from "../../layouts/AdminLayout.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000/api";
const token = Astro.cookies.get("token")?.value;

if (!token) {
    return Astro.redirect("/login");
}

import type { Role, Permission } from "../../types/admin";

let roles: Role[] = [];
let permissions: Permission[] = [];
let error = null;

try {
    const rolesRes = await fetch(`${API_URL}/roles`, {
        headers: { Authorization: `Bearer ${token}` },
    });
    if (rolesRes.ok) {
        roles = await rolesRes.json();
    } else {
        error = "No se pudieron cargar los roles";
    }

    const permsRes = await fetch(`${API_URL}/permissions`, {
        headers: { Authorization: `Bearer ${token}` },
    });
    if (permsRes.ok) {
        permissions = await permsRes.json();
    } else {
        error = "No se pudieron cargar los permisos";
    }
} catch (e) {
    console.error("Error fetching data:", e);
    error = "Error de conexión";
}
---

<AdminLayout title="Gestión de Permisos">
    <div class="p-6">
        <h1 class="text-3xl font-bold text-accent-main mb-8">
            Matriz de Permisos
        </h1>

        {
            error && (
                <div class="bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded mb-6">
                    {error}
                </div>
            )
        }

        <div
            class="overflow-x-auto bg-bg-secondary rounded-lg border border-white/10"
        >
            <table class="w-full text-left text-sm text-text-main">
                <thead class="bg-bg-main text-text-secondary uppercase">
                    <tr>
                        <th class="px-6 py-3 border-b border-white/10"
                            >Permiso</th
                        >
                        {
                            roles.map((role) => (
                                <th class="px-6 py-3 border-b border-white/10 text-center">
                                    {role.name}
                                </th>
                            ))
                        }
                        <th
                            class="px-6 py-3 border-b border-white/10 text-center"
                        >
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {
                        permissions.map((perm) => (
                            <tr class="hover:bg-white/5 transition-colors">
                                <td class="px-6 py-4 font-medium">
                                    {perm.name}
                                </td>
                                {roles.map((role) => {
                                    const hasPerm = role.permissions?.some(
                                        (p) => p.id === perm.id,
                                    );
                                    return (
                                        <td class="px-6 py-4 text-center">
                                            <input
                                                type="checkbox"
                                                class="form-checkbox h-5 w-5 text-accent-main rounded border-gray-600 bg-gray-700 focus:ring-offset-gray-900"
                                                checked={hasPerm}
                                                data-role-id={role.id}
                                                data-perm-name={perm.name}
                                                disabled={role.name === "ADMIN"}
                                            />
                                        </td>
                                    );
                                })}
                                <td class="px-6 py-4 text-center text-text-secondary italic">
                                    Toggle to Change
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-end">
            <button
                id="saveBtn"
                class="bg-accent-main hover:bg-accent-secondary text-white font-bold py-2 px-6 rounded transition-colors"
            >
                Guardar Cambios
            </button>
        </div>
    </div>
    fo
</AdminLayout>

<script define:vars={{ roles, API_URL, token }}>
    import Swal from "sweetalert2";

    const saveBtn = document.getElementById("saveBtn");
    const checkboxes = document.querySelectorAll(
        'input[type="checkbox"][data-role-id]',
    );

    saveBtn.addEventListener("click", async () => {
        saveBtn.disabled = true;
        saveBtn.innerText = "Guardando...";

        try {
            // Group permissions by role
            const rolePermissions = {};

            // Initialize with current state from DOM
            checkboxes.forEach((cb) => {
                const roleId = cb.dataset.roleId;
                const permName = cb.dataset.permName;

                if (!roleId) return;

                if (!rolePermissions[roleId]) {
                    rolePermissions[roleId] = [];
                }

                if (cb.checked) {
                    rolePermissions[roleId].push(permName);
                }
            });

            // Send updates for each role (except Admin if disabled)
            const promises = Object.keys(rolePermissions).map(
                async (roleId) => {
                    // Skip if roleId corresponds to ADMIN (assuming ID 1 is ADMIN, or check logic)
                    // Or just trust the backend/checkbox state.
                    // We will send specific update for each role

                    const res = await fetch(
                        `${API_URL}/roles/${roleId}/permissions`,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                            },
                            body: JSON.stringify({
                                permissionNames: rolePermissions[roleId],
                            }),
                        },
                    );
                    if (!res.ok)
                        throw new Error(`Error updating role ${roleId}`);
                },
            );

            await Promise.all(promises);

            Swal.fire({
                icon: "success",
                title: "Permisos Actualizados",
                text: "Los cambios se guardaron correctamente.",
                background: "#1f2937",
                color: "#fff",
                confirmButtonColor: "#f97316",
            }).then(() => {
                window.location.reload();
            });
        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Hubo un problema al guardar los permisos.",
                background: "#1f2937",
                color: "#fff",
            });
            saveBtn.disabled = false;
            saveBtn.innerText = "Guardar Cambios";
        }
    });
</script>
