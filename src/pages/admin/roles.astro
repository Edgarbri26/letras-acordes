---
import AdminLayout from "../../layouts/AdminLayout.astro";
import type { Role, Permission } from "../../types/admin";
import { API_URL } from "@/services/songs";

const token = Astro.cookies.get("token")?.value;

if (!token) {
    return Astro.redirect("/login");
}

let roles: Role[] = [];
let permissions: Permission[] = [];
let error: string | null = null;

try {
    const headers: HeadersInit = {
        Authorization: `Bearer ${token}`,
    };

    const rolesReq = fetch(`${API_URL}/roles`, { headers });
    const permsReq = fetch(`${API_URL}/permissions`, { headers });

    const [rRes, pRes] = await Promise.all([rolesReq, permsReq]);

    if (!rRes.ok) {
        throw new Error("Error cargando roles");
    }
    roles = await rRes.json();
    roles = roles.filter((role) => role.name !== "ADMIN");

    if (!pRes.ok) {
        throw new Error("Error cargando permisos");
    }
    permissions = await pRes.json();
} catch (err) {
    console.error("Error loading admin data:", err);
    error = err instanceof Error ? err.message : "Error de conexión o datos";
}
---

<AdminLayout title="Gestión de Roles">
    <div
        id="roles-page"
        class="w-full"
        data-api-url={API_URL}
        data-token={token}
    >
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-accent-main">
                Gestión de Roles y Permisos
            </h1>
            <button
                id="createRoleBtn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center gap-2"
            >
                <i
                    class="fa-solid fa-plus-circle h-5 w-5 flex items-center justify-center"
                ></i>
                Crear Rol
            </button>
        </div>

        {
            error && (
                <div class="bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded mb-6">
                    {error}
                </div>
            )
        }

        <div
            class="overflow-x-auto bg-bg-secondary rounded-lg border border-white/10"
        >
            <table class="w-full text-left text-sm text-text-main">
                <thead class="bg-bg-main text-text-secondary uppercase">
                    <tr>
                        <th class="px-6 py-3 border-b border-white/10"
                            >Permiso</th
                        >
                        {
                            roles.map((role) => (
                                <th class="px-6 py-3 border-b border-white/10 text-center min-w-[120px]">
                                    <div class="flex items-center justify-center gap-2">
                                        <span>{role.name}</span>
                                        {role.name !== "ADMIN" && (
                                            <button
                                                class="text-gray-400 hover:text-accent-main transition-colors edit-role-btn"
                                                data-role-id={role.id}
                                                data-role-name={role.name}
                                                title="Editar nombre del rol"
                                            >
                                                <i class="fa-solid fa-pen-to-square h-4 w-4" />
                                            </button>
                                        )}
                                    </div>
                                </th>
                            ))
                        }
                        <th
                            class="px-6 py-3 border-b border-white/10 text-center"
                        >
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {
                        permissions.map((perm) => (
                            <tr class="hover:bg-white/5 transition-colors">
                                <td class="px-6 py-4 font-medium">
                                    {perm.name}
                                </td>
                                {roles.map((role) => {
                                    const hasPerm = role.permissions?.some(
                                        (p) => p.id === perm.id,
                                    );
                                    return (
                                        <td class="px-6 py-4 text-center">
                                            <input
                                                type="checkbox"
                                                class="form-checkbox h-5 w-5 text-accent-main rounded border-gray-600 bg-gray-700 focus:ring-offset-gray-900"
                                                checked={hasPerm}
                                                data-role-id={role.id}
                                                data-perm-name={perm.name}
                                                disabled={role.name === "ADMIN"}
                                            />
                                        </td>
                                    );
                                })}
                                <td class="px-6 py-4 text-center text-text-secondary italic">
                                    Toggle to Change
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-end">
            <button
                id="saveBtn"
                class="bg-accent-main hover:bg-accent-secondary text-white font-bold py-2 px-6 rounded transition-colors"
            >
                Guardar Cambios
            </button>
        </div>
    </div>
</AdminLayout>

<script>
    import Swal from "sweetalert2";

    const pageContainer = document.getElementById("roles-page");
    const API_URL = pageContainer?.dataset.apiUrl;
    const token = pageContainer?.dataset.token;

    const saveBtn = document.getElementById("saveBtn") as HTMLButtonElement;
    const createRoleBtn = document.getElementById("createRoleBtn");
    const editRoleBtns = document.querySelectorAll(".edit-role-btn");
    const checkboxes = document.querySelectorAll(
        'input[type="checkbox"][data-role-id]',
    ) as NodeListOf<HTMLInputElement>;

    // Configuración común de Swal
    const swalDark = {
        background: "#1f2937",
        color: "#fff",
        confirmButtonColor: "#f97316",
        cancelButtonColor: "#4b5563",
    };

    // Crear Nuevo Rol
    createRoleBtn?.addEventListener("click", async () => {
        const { value: roleName } = await Swal.fire({
            ...swalDark,
            title: "Crear Nuevo Rol",
            input: "text",
            inputLabel: "Nombre del Rol",
            inputPlaceholder: "Ej: MUSICO",
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value) {
                    return "¡Debes escribir un nombre!";
                }
            },
        });

        if (roleName) {
            try {
                const res = await fetch(`${API_URL}/roles`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        name: roleName.toUpperCase(),
                        permissions: [],
                    }),
                });

                if (res.ok) {
                    Swal.fire({
                        ...swalDark,
                        icon: "success",
                        title: "¡Éxito!",
                        text: "Rol creado correctamente",
                    }).then(() => window.location.reload());
                } else {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || "Error al crear rol");
                }
            } catch (e) {
                console.error(e);
                Swal.fire({
                    ...swalDark,
                    icon: "error",
                    title: "Error",
                    text:
                        e instanceof Error
                            ? e.message
                            : "No se pudo crear el rol",
                });
            }
        }
    });

    // Editar Nombre del Rol
    editRoleBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
            if (!(btn instanceof HTMLElement)) return;
            const roleId = btn.dataset.roleId;
            const currentName = btn.dataset.roleName;

            const { value: newName } = await Swal.fire({
                ...swalDark,
                title: "Editar Nombre del Rol",
                input: "text",
                inputValue: currentName,
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) return "¡El nombre no puede estar vacío!";
                },
            });

            if (newName && newName !== currentName) {
                try {
                    const res = await fetch(`${API_URL}/roles/${roleId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({ name: newName.toUpperCase() }),
                    });

                    if (res.ok) {
                        Swal.fire({
                            ...swalDark,
                            icon: "success",
                            title: "Actualizado",
                            text: "Nombre del rol actualizado",
                        }).then(() => window.location.reload());
                    } else {
                        throw new Error("Error al actualizar");
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire({
                        ...swalDark,
                        icon: "error",
                        title: "Error",
                        text: "No se pudo actualizar el rol",
                    });
                }
            }
        });
    });

    saveBtn?.addEventListener("click", async () => {
        saveBtn.disabled = true;
        saveBtn.innerText = "Guardando...";

        try {
            // Group permissions by role
            const rolePermissions: Record<string, string[]> = {};

            // Initialize with current state from DOM
            checkboxes.forEach((cb) => {
                const roleId = cb.dataset.roleId;
                const permName = cb.dataset.permName;

                if (!roleId || !permName) return;

                if (!rolePermissions[roleId]) {
                    rolePermissions[roleId] = [];
                }

                if (cb.checked) {
                    rolePermissions[roleId].push(permName);
                }
            });

            // Send updates for each role
            const promises = Object.keys(rolePermissions).map(
                async (roleId) => {
                    const res = await fetch(
                        `${API_URL}/roles/${roleId}/permissions`,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                            },
                            body: JSON.stringify({
                                permissionNames: rolePermissions[roleId],
                            }),
                        },
                    );
                    if (!res.ok)
                        throw new Error(`Error updating role ${roleId}`);
                },
            );

            await Promise.all(promises);

            Swal.fire({
                ...swalDark,
                icon: "success",
                title: "Permisos Actualizados",
                text: "Los cambios se guardaron correctamente.",
            }).then(() => {
                window.location.reload();
            });
        } catch (error) {
            console.error(error);
            Swal.fire({
                ...swalDark,
                icon: "error",
                title: "Error",
                text: "Hubo un problema al guardar los permisos.",
            });
            saveBtn.disabled = false;
            saveBtn.innerText = "Guardar Cambios";
        }
    });
</script>
