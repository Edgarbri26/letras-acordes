---
// export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import SongCard from "@/components/SongCard.astro";
import { getUserFromToken } from "@/utils/auth";
import type { Song } from "../../types/song";
import type { Category } from "../../types/category";
import { API_URL } from "@/services/songs";

const { search } = Astro.params;
const decodedSearch = search ? decodeURIComponent(search) : "";

let songs: Song[] = [];
let categories: Category[] = [];
let error = null;

try {
    const q = decodedSearch === "all" ? "" : decodedSearch || "";
    // If q is present in URL (e.g. from ?q=...), it might override params.search?
    // Actually, Layout Header redirects to /search/[term]. So [term] IS the query.
    // We can also check if there is a ?q param for legacy or direct access, but let's stick to using `q` variable from params.
    // However, the backend expects `q` query param.

    // Logic:
    // If search param is "all", we treat it as empty query for backend.

    // Get category filter if present
    const categoryId = Astro.url.searchParams.get("categoryId") || "";
    const activeParam = Astro.url.searchParams.get("active");

    // Fetch songs
    // Fetch songs
    const token = Astro.cookies.get("token")?.value;
    const headers: Record<string, string> = token
        ? { Authorization: `Bearer ${token}` }
        : {};

    const res = await fetch(
        `${API_URL}/songs?q=${encodeURIComponent(q)}&categoryId=${categoryId}&active=${activeParam || ""}`,
        { headers },
    );
    if (!res.ok) throw new Error("Failed to fetch songs");
    songs = await res.json();
    songs.reverse();

    // Fetch categories
    const catRes = await fetch(`${API_URL}/categories`, { headers });
    if (catRes.ok) {
        categories = await catRes.json();
        const user = getUserFromToken(token);
        if (user?.role === "ADMIN") {
            categories.push({ id: -1, name: "Inactivas" } as any);
        }
    }
} catch (e) {
    if (e instanceof Error) {
        error = e.message;
    } else {
        error = String(e);
        console.error("Error fetching songs:", error);
    }
}

const currentCategoryId = Astro.url.searchParams.get("categoryId");
---

<Layout title={`CancioneroDigital - Buscando: ${decodedSearch}`}>
    <div class="flex flex-col min-h-screen bg-bg-main text-text-main">
        <main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
            <h1 class="text-3xl font-bold text-accent-main mb-8">
                {
                    decodedSearch === "all"
                        ? "Todas las canciones"
                        : `Resultados para: "${decodedSearch}"`
                }
            </h1>

            <!-- CategorÃ­as -->
            <div class="flex flex-wrap gap-2 mb-8">
                <a
                    href={`/search/${decodedSearch === "all" ? "all" : encodeURIComponent(decodedSearch)}`}
                    class={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${!currentCategoryId ? "bg-accent-main text-white" : "bg-bg-secondary text-text-secondary hover:text-white hover:bg-white/10"}`}
                >
                    Todas
                </a>
                
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {songs?.map((song) => <SongCard song={song} />)}
            </div>

            {
                (!songs || songs.length === 0) && (
                    <div class="text-center py-20 opacity-50">
                        <p class="text-xl mb-4">No se encontraron resultados</p>
                        <a
                            href="/search/all"
                            class="text-accent-main hover:underline"
                        >
                            Ver todas las canciones
                        </a>
                    </div>
                )
            }
        </main>
    </div>
</Layout>
