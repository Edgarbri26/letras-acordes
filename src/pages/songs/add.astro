---
// export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import ChordEditor from "@/components/ChordEditor.jsx";
import { supabase } from "@/lib/supabase";
import "@/styles/global.css";
import type { Category } from "@/types/category";
import { createSong, API_URL } from "@/services/songs";
import { getUserFromToken, hasPermission } from "@/utils/auth";

const token = Astro.cookies.get("token")?.value;
const user = getUserFromToken(token);

if (!token || !user) {
    return Astro.redirect("/login");
}

if (!hasPermission(user, "song.create")) {
    return Astro.redirect("/");
}

let categories: Category[] = [];
try {
    const res = await fetch(`${API_URL}/categories`);
    if (res.ok) {
        categories = await res.json();
    }
} catch (e) {
    console.error("Error fetching categories:", e);
}

let errorMessage = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const result = await createSong(formData, token);

    if (result.success) {
        return Astro.redirect(`/songs/${result.data.id}`);
    } else {
        errorMessage = result.error || "Error desconocido";
    }
}
---

<Layout title="Subir Canción">
    <div class="flex flex-col h-full bg-bg-main text-text-main">
        <main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
            <h1 class="text-3xl font-bold text-accent-main mb-8">
                Enviar Cifrado
            </h1>

            {}

            <form class="space-y-8" method="POST">
                {/* Info Básica (Grid de 3 columnas para aprovechar espacio) */}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label
                            for="artist"
                            class="block text-sm font-medium text-text-secondary"
                            >Artista / Banda</label
                        >
                        <input
                            type="text"
                            id="artist"
                            name="artist"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Cindy Barrera"
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="title"
                            class="block text-sm font-medium text-text-secondary"
                            >Nombre de la canción</label
                        >
                        <input
                            type="text"
                            id="title"
                            name="title"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Dios está aquí"
                            required
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="key"
                            class="block text-sm font-medium text-text-secondary"
                            >Tono Principal</label
                        >
                        <select
                            id="key"
                            name="key"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors appearance-none cursor-pointer"
                        >
                            {
                                [
                                    "C",
                                    "Cm",
                                    "C#",
                                    "C#m",
                                    "D",
                                    "Dm",
                                    "D#",
                                    "D#m",
                                    "E",
                                    "Em",
                                    "F",
                                    "Fm",
                                    "F#",
                                    "F#m",
                                    "G",
                                    "Gm",
                                    "G#",
                                    "G#m",
                                    "A",
                                    "Am",
                                    "A#",
                                    "A#m",
                                    "B",
                                    "Bm",
                                ].map((k) => <option value={k}>{k}</option>)
                            }
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label
                            for="url_song"
                            class="block text-sm font-medium text-text-secondary"
                            >Link del Video (YouTube)</label
                        >
                        <input
                            type="url"
                            id="url_song"
                            name="url_song"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="https://youtube.com/..."
                        />
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label
                                for="categoryId"
                                class="block text-sm font-medium text-text-secondary"
                                >Categoría</label
                            >
                            <button
                                type="button"
                                id="btn-new-category"
                                class="text-xs text-accent-main hover:text-white underline transition-colors"
                            >
                                + Nueva Categoría
                            </button>
                        </div>
                        <select
                            id="categoryId"
                            name="categoryId"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors appearance-none cursor-pointer"
                        >
                            {
                                categories.map((cat) => (
                                    <option value={cat.id}>{cat.name}</option>
                                ))
                            }
                        </select>
                    </div>
                </div>

                <div class="border-t border-white/10 pt-6">
                    <div
                        class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
                    >
                        <div>
                            <h3 class="text-xl font-semibold text-white">
                                Letra y Acordes
                            </h3>
                            <p class="text-sm text-text-secondary">
                                Escribe la letra y usa los botones para insertar
                                los acordes en la posición exacta.
                            </p>
                        </div>
                        <button
                            type="button"
                            id="btn-ai-autocomplete"
                            title="Completar acordes con IA"
                            class="flex items-center gap-2 bg-linear-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-full shadow-md transition-all transform hover:scale-105"
                        >
                            <span>✨</span> Generar acordes con IA
                        </button>
                    </div>

                    {/* AQUÍ VA LA MAGIA DE REACT */}
                    {
                        /* Pasamos 'name="content"' para que el form lo reconozca */
                    }
                    <ChordEditor client:only="react" name="content" />
                </div>

                <div class="flex justify-end pt-4">
                    <button
                        type="submit"
                        class="bg-accent-main hover:bg-accent-main/90 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-lg shadow-accent-main/20"
                    >
                        Guardar Canción
                    </button>
                </div>
            </form>
        </main>
    </div>
    {/* Modal para crear categoría */}
    <dialog
        id="modal-category"
        class="bg-bg-secondary text-text-main border border-white/10 rounded-lg p-6 backdrop:backdrop-blur-sm shadow-xl w-full max-w-sm"
    >
        <form method="dialog" class="space-y-4">
            <h3 class="text-lg font-bold">Nueva Categoría</h3>
            <div class="space-y-2">
                <label for="new-cat-name" class="text-sm text-text-secondary"
                    >Nombre</label
                >
                <input
                    type="text"
                    id="new-cat-name"
                    class="w-full bg-bg-main border border-white/10 rounded p-2 focus:border-accent-main focus:outline-none"
                    placeholder="Ej. Adoración"
                />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button
                    value="cancel"
                    class="px-4 py-2 text-sm text-text-secondary hover:text-white transition-colors"
                    >Cancelar</button
                >
                <button
                    id="btn-save-category"
                    type="button"
                    class="px-4 py-2 text-sm bg-accent-main text-white rounded hover:bg-accent-main/90 transition-colors"
                    >Guardar</button
                >
            </div>
        </form>
    </dialog>

    <div
        id="add-song-data"
        data-api-url={API_URL}
        data-error-message={errorMessage}
        class="hidden"
    >
    </div>

    <script lang="ts">
        // import {
        //     showError,
        //     showSuccessToast,
        //     showConfirm,
        // } from "@/utils/alerts";

        console.log("Script starting in add.astro");

        // document.addEventListener("DOMContentLoaded", () => {
        const dataElement = document.getElementById("add-song-data");
        const API_URL = dataElement?.dataset.apiUrl;
        const errorMessage = dataElement?.dataset.errorMessage;

        if (errorMessage) {
            // showError("Error", errorMessage);
            console.error("Error Message:", errorMessage);
        }

        // --- Category Logic ---
        console.log("Initializing category logic...");

        const btnNewCategory =
            document.querySelector<HTMLButtonElement>("#btn-new-category");
        const modalCategory =
            document.querySelector<HTMLDialogElement>("#modal-category");
        const btnSaveCategory =
            document.querySelector<HTMLButtonElement>("#btn-save-category");
        const inputCatName =
            document.querySelector<HTMLInputElement>("#new-cat-name");
        const selectCategory =
            document.querySelector<HTMLSelectElement>("#categoryId");
        const closeCategoryBtn = document.querySelector(
            "#modal-category button[value='cancel']",
        );

        console.log("btnNewCategory:", btnNewCategory);
        console.log("modalCategory:", modalCategory);

        if (btnNewCategory && modalCategory) {
            console.log("Adding click listener to btnNewCategory");
            btnNewCategory.addEventListener("click", (e) => {
                console.log("btnNewCategory clicked");
                e.preventDefault();
                modalCategory.showModal();
                if (inputCatName) {
                    inputCatName.value = "";
                    inputCatName.focus();
                }
            });
        } else {
            console.error("Elements not found:", {
                btnNewCategory,
                modalCategory,
            });
        }

        if (closeCategoryBtn && modalCategory) {
            closeCategoryBtn.addEventListener("click", (e) => {
                e.preventDefault();
                modalCategory.close();
            });
        }

        if (btnSaveCategory) {
            btnSaveCategory.addEventListener("click", async () => {
                const name = inputCatName?.value.trim();
                if (!name) return;

                try {
                    btnSaveCategory.disabled = true;
                    btnSaveCategory.textContent = "Guardando...";

                    if (!API_URL) throw new Error("API URL not found");

                    const res = await fetch(`${API_URL}/categories`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name }),
                    });

                    if (res.ok) {
                        const newCat = await res.json();
                        // Agregar al select
                        const option = document.createElement("option");
                        option.value = newCat.id;
                        option.textContent = newCat.name;
                        option.selected = true; // Seleccionar automáticamente
                        selectCategory?.appendChild(option);

                        modalCategory?.close();

                        // showSuccessToast("¡Categoría creada!");
                        console.log("¡Categoría creada!");
                    } else {
                        const err = await res.json();
                        // showError("Error", "Error al crear la categoría");
                        console.error("Error al crear la categoría", err);
                    }
                } catch (e) {
                    console.error(e);
                    // showError("Error", "Error de conexión");
                    console.error("Error de conexión");
                } finally {
                    btnSaveCategory.disabled = false;
                    btnSaveCategory.textContent = "Guardar";
                }
            });
        }

        // --- Main Form Logic ---
        const mainForm = document.querySelector("main form");
        const mainSubmitBtn = mainForm?.querySelector("button[type='submit']");

        if (mainForm) {
            mainForm.addEventListener("submit", () => {
                if (mainSubmitBtn) {
                    mainSubmitBtn.setAttribute("disabled", "true");
                    mainSubmitBtn.innerHTML = "Guardando...";
                    mainSubmitBtn.classList.add(
                        "opacity-75",
                        "cursor-not-allowed",
                    );
                }
            });
        }

        // --- AI Autocomplete Logic ---
        const btnAI = document.getElementById("btn-ai-autocomplete");
        console.log("Searching for AI button...", btnAI);

        if (btnAI) {
            btnAI.addEventListener("click", async () => {
                console.log("AI Button Clicked");
                const titleInput =
                    document.querySelector<HTMLInputElement>("#title");
                const keySelect =
                    document.querySelector<HTMLSelectElement>("#key");
                const contentInput = document.querySelector<
                    HTMLTextAreaElement | HTMLInputElement
                >('[name="content"]');

                console.log("Inputs found:", {
                    title: !!titleInput,
                    key: !!keySelect,
                    content: !!contentInput,
                });

                const title = titleInput?.value || "";
                const key = keySelect?.value || "";
                const content = contentInput?.value || "";

                if (!title || !key || !content) {
                    console.error("Datos incompletos");
                    alert("Por favor agrega el Título, Tono y la Letra");
                    return;
                }

                // 1. Confirm with user
                const confirmResult = confirm(
                    "¿Deseas intentar autocompletar los acordes?",
                );

                if (!confirmResult) return;

                console.log("--- AI Autocomplete Context ---");
                console.log("Title:", title);
                console.log("Key:", key);
                console.log("Content:", content);
                console.log("-------------------------------");

                // showSuccessToast(
                //     "IA Completando...",
                //     "Enviando datos para autocompletar...",
                // );
                alert("IA Completando... (Simulado)");

                // TODO: Implement actual API call here
                // const res = await fetch('/api/ai/autocomplete', { ... });
            });
        }

        // --- Key Logic ---
        const keySelect = document.querySelector<HTMLSelectElement>("#key");

        keySelect?.addEventListener("change", (e) => {
            if (e.target instanceof HTMLSelectElement) {
                const newKey = e.target.value;
                const event = new CustomEvent("song-key-change", {
                    detail: { key: newKey },
                });
                window.dispatchEvent(event);
            }
        });

        // Escuchar cambios desde el editor de acordes
        window.addEventListener("editor-key-change", (e) => {
            if (e instanceof CustomEvent) {
                if (keySelect && e.detail && e.detail.key) {
                    keySelect.value = e.detail.key;
                }
            }
        });
        // });
    </script>
</Layout>
