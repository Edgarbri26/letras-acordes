---
// export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import ChordEditor from "@/components/ChordEditor.jsx";
import { supabase } from "@/lib/supabase";
import "@/styles/global.css";
import type { Category } from "@/types/category";
import { createSong, API_URL } from "@/services/songs";
import { autocompleteChordsWithAI } from "@/services/ai";
import { getUserFromToken, hasPermission } from "@/utils/auth";

const token = Astro.cookies.get("token")?.value;
const user = getUserFromToken(token);

if (!token || !user) {
    return Astro.redirect("/login");
}

if (!hasPermission(user, "song.create")) {
    return Astro.redirect("/");
}

let categories: Category[] = [];
try {
    const res = await fetch(`${API_URL}/categories`);
    if (res.ok) {
        categories = await res.json();
    }
} catch (e) {
    console.error("Error fetching categories:", e);
}

let errorMessage = "";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const result = await createSong(formData, token);

    if (result.success) {
        return Astro.redirect(`/songs/${result.data.id}`);
    } else {
        errorMessage = result.error || "Error desconocido";
    }
}
---

<Layout title="Subir Canci√≥n">
    <div class="flex flex-col h-full bg-bg-main text-text-main">
        <main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
            <h1 class="text-3xl font-bold text-accent-main mb-8">
                Enviar Cifrado
            </h1>

            {}

            <form class="space-y-8" method="POST">
                {/* Info B√°sica (Grid de 3 columnas para aprovechar espacio) */}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label
                            for="artist"
                            class="block text-sm font-medium text-text-secondary"
                            >Artista / Banda</label
                        >
                        <input
                            type="text"
                            id="artist"
                            name="artist"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Cindy Barrera"
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="title"
                            class="block text-sm font-medium text-text-secondary"
                            >Nombre de la canci√≥n</label
                        >
                        <input
                            type="text"
                            id="title"
                            name="title"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Dios est√° aqu√≠"
                            required
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="key"
                            class="block text-sm font-medium text-text-secondary"
                            >Tono Principal</label
                        >
                        <select
                            id="key"
                            name="key"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors appearance-none cursor-pointer"
                        >
                            {
                                [
                                    "C",
                                    "Cm",
                                    "C#",
                                    "C#m",
                                    "D",
                                    "Dm",
                                    "D#",
                                    "D#m",
                                    "E",
                                    "Em",
                                    "F",
                                    "Fm",
                                    "F#",
                                    "F#m",
                                    "G",
                                    "Gm",
                                    "G#",
                                    "G#m",
                                    "A",
                                    "Am",
                                    "A#",
                                    "A#m",
                                    "B",
                                    "Bm",
                                ].map((k) => <option value={k}>{k}</option>)
                            }
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label
                            for="url_song"
                            class="block text-sm font-medium text-text-secondary"
                            >Link del Video (YouTube)</label
                        >
                        <input
                            type="url"
                            id="url_song"
                            name="url_song"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="https://youtube.com/..."
                        />
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label
                                for="categoryId"
                                class="block text-sm font-medium text-text-secondary"
                                >Categor√≠a</label
                            >
                            <button
                                type="button"
                                id="btn-new-category"
                                class="text-xs text-accent-main hover:text-white underline transition-colors"
                            >
                                + Nueva Categor√≠a
                            </button>
                        </div>
                        <select
                            id="categoryId"
                            name="categoryId"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors appearance-none cursor-pointer"
                        >
                            {
                                categories.map((cat) => (
                                    <option value={cat.id}>{cat.name}</option>
                                ))
                            }
                        </select>
                    </div>
                </div>

                <div class="border-t border-white/10 pt-6">
                    <div
                        class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
                    >
                        <div>
                            <h3 class="text-xl font-semibold text-white">
                                Letra y Acordes
                            </h3>
                            <p class="text-sm text-text-secondary">
                                Escribe la letra y usa los botones para insertar
                                los acordes en la posici√≥n exacta.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button
                                type="button"
                                id="btn-ai-search-song"
                                title="Buscar canci√≥n original por fragmento de letra"
                                class="flex items-center gap-2 bg-linear-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white text-sm font-bold py-2 px-4 rounded-full shadow-md transition-all transform hover:scale-105"
                            >
                                <span>üîç</span> Buscar canci√≥n por letra
                            </button>
                            <button
                                type="button"
                                id="btn-ai-autocomplete"
                                title="Completar acordes con IA"
                                class="flex items-center gap-2 bg-linear-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-full shadow-md transition-all transform hover:scale-105"
                            >
                                <span>‚ú®</span> Generar acordes con IA
                            </button>
                        </div>
                    </div>

                    {/* AQU√ç VA LA MAGIA DE REACT */}
                    {
                        /* Pasamos 'name="content"' para que el form lo reconozca */
                    }
                    <ChordEditor client:only="react" name="content" />
                </div>

                <div class="flex justify-end pt-4">
                    <button
                        type="submit"
                        class="bg-accent-main hover:bg-accent-main/90 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-lg shadow-accent-main/20"
                    >
                        Guardar Canci√≥n
                    </button>
                </div>
            </form>
        </main>
    </div>
    {/* Modal para crear categor√≠a */}
    <dialog
        id="modal-category"
        class="bg-bg-secondary text-text-main border border-white/10 rounded-lg p-6 backdrop:backdrop-blur-sm shadow-xl w-full max-w-sm m-auto"
    >
        <form method="dialog" class="space-y-4">
            <h3 class="text-lg font-bold">Nueva Categor√≠a</h3>
            <div class="space-y-2">
                <label for="new-cat-name" class="text-sm text-text-secondary"
                    >Nombre</label
                >
                <input
                    type="text"
                    id="new-cat-name"
                    class="w-full bg-bg-main border border-white/10 rounded p-2 focus:border-accent-main focus:outline-none"
                    placeholder="Ej. Adoraci√≥n"
                />
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button
                    value="cancel"
                    class="px-4 py-2 text-sm text-text-secondary hover:text-white transition-colors"
                    >Cancelar</button
                >
                <button
                    id="btn-save-category"
                    type="button"
                    class="px-4 py-2 text-sm bg-accent-main text-white rounded hover:bg-accent-main/90 transition-colors"
                    >Guardar</button
                >
            </div>
        </form>
    </dialog>

    <div
        id="add-song-data"
        data-api-url={API_URL}
        data-error-message={errorMessage}
        data-token={token}
        class="hidden"
    >
    </div>

    <script lang="ts">
        // import {
        //     showError,
        //     showSuccessToast,
        //     showConfirm,
        // } from "@/utils/alerts";

        console.log("Script starting in add.astro");

        document.addEventListener("DOMContentLoaded", () => {
            const dataElement = document.getElementById("add-song-data");
            const API_URL = dataElement?.dataset.apiUrl;
            const errorMessage = dataElement?.dataset.errorMessage;
            const token = dataElement?.dataset.token;

            if (errorMessage) {
                console.error("Error Message:", errorMessage);
            }

            // --- Category Logic ---
            console.log("Initializing category logic...");

            const btnNewCategory = document.querySelector("#btn-new-category");
            const modalCategory = document.querySelector("#modal-category");
            const btnSaveCategory =
                document.querySelector("#btn-save-category");
            const inputCatName = document.querySelector("#new-cat-name");
            const selectCategory = document.querySelector("#categoryId");
            const closeCategoryBtn = document.querySelector(
                "#modal-category button[value='cancel']",
            );

            console.log("btnNewCategory:", btnNewCategory);
            console.log("modalCategory:", modalCategory);

            if (btnNewCategory && modalCategory) {
                console.log("Adding click listener to btnNewCategory");
                btnNewCategory.addEventListener("click", (e) => {
                    console.log("btnNewCategory clicked");
                    e.preventDefault();
                    modalCategory.showModal();
                    if (inputCatName) {
                        inputCatName.value = "";
                        inputCatName.focus();
                    }
                });
            } else {
                console.error("Elements not found:", {
                    btnNewCategory,
                    modalCategory,
                });
            }

            if (closeCategoryBtn && modalCategory) {
                closeCategoryBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    modalCategory.close();
                });
            }

            if (btnSaveCategory) {
                btnSaveCategory.addEventListener("click", async () => {
                    const name = inputCatName?.value.trim();
                    if (!name) return;

                    try {
                        btnSaveCategory.disabled = true;
                        btnSaveCategory.textContent = "Guardando...";

                        if (!API_URL) throw new Error("API URL not found");

                        const headers = {
                            "Content-Type": "application/json",
                        };

                        if (token) {
                            headers["Authorization"] = `Bearer ${token}`;
                        }

                        const res = await fetch(`${API_URL}/categories`, {
                            method: "POST",
                            headers: headers,
                            body: JSON.stringify({ name }),
                        });

                        if (res.ok) {
                            const newCat = await res.json();
                            // Agregar al select
                            const option = document.createElement("option");
                            option.value = newCat.id;
                            option.textContent = newCat.name;
                            option.selected = true; // Seleccionar autom√°ticamente
                            selectCategory?.appendChild(option);

                            modalCategory?.close();

                            console.log("¬°Categor√≠a creada!");
                        } else {
                            const err = await res.json();
                            console.error("Error al crear la categor√≠a", err);
                        }
                    } catch (e) {
                        console.error(e);
                        console.error("Error de conexi√≥n");
                    } finally {
                        btnSaveCategory.disabled = false;
                        btnSaveCategory.textContent = "Guardar";
                    }
                });
            }

            // --- Main Form Logic ---
            const mainForm = document.querySelector("main form");
            const mainSubmitBtn = mainForm?.querySelector(
                "button[type='submit']",
            );

            if (mainForm) {
                mainForm.addEventListener("submit", () => {
                    if (mainSubmitBtn) {
                        mainSubmitBtn.setAttribute("disabled", "true");
                        mainSubmitBtn.innerHTML = "Guardando...";
                        mainSubmitBtn.classList.add(
                            "opacity-75",
                            "cursor-not-allowed",
                        );
                    }
                });
            }

            // --- AI Autocomplete Logic ---
            const btnAI = document.getElementById("btn-ai-autocomplete");
            console.log("Searching for AI button...", btnAI);

            if (btnAI) {
                btnAI.addEventListener("click", async () => {
                    console.log("AI Button Clicked");
                    const titleInput = document.querySelector("#title");
                    const keySelect = document.querySelector("#key");
                    const contentInput =
                        document.querySelector('[name="content"]');

                    console.log("Inputs found:", {
                        title: !!titleInput,
                        key: !!keySelect,
                        content: !!contentInput,
                    });

                    const title = titleInput?.value || "";
                    const key = keySelect?.value || "";
                    const content = contentInput?.value || "";

                    if (!title || !key || !content) {
                        console.error("Datos incompletos");
                        alert(
                            "Por favor agrega el T√≠tulo, Tono y la Letra antes de generar acordes",
                        );
                        return;
                    }

                    // Confirmar con el usuario
                    const confirmResult = confirm(
                        "¬øDeseas que la IA genere los acordes para esta canci√≥n?\n\nEsto reemplazar√° el contenido actual con la versi√≥n con acordes.",
                    );

                    if (!confirmResult) return;

                    console.log("--- AI Autocomplete Context ---");
                    console.log("Title:", title);
                    console.log("Key:", key);
                    console.log("Content:", content);
                    console.log("-------------------------------");

                    try {
                        // Deshabilitar bot√≥n y mostrar estado de carga
                        btnAI.disabled = true;
                        const originalText = btnAI.innerHTML;
                        btnAI.innerHTML =
                            '<span class="animate-pulse">‚è≥ Generando acordes...</span>';
                        btnAI.classList.add("opacity-75", "cursor-not-allowed");

                        // Importar din√°micamente el servicio de IA
                        const { autocompleteChordsWithAI } =
                            await import("/src/services/ai.ts");

                        // Llamar al servicio para autocompletar acordes
                        const result = await autocompleteChordsWithAI(
                            {
                                title: title,
                                tone: key,
                                lyrics: content,
                            },
                            token,
                        );

                        if (!result.success) {
                            throw new Error(
                                result.error || "Error al generar acordes",
                            );
                        }

                        const data = result.data;
                        console.log("AI Response:", data);

                        if (data && data.chordPro) {
                            // Disparar evento personalizado para que React actualice el editor
                            window.dispatchEvent(
                                new CustomEvent("update-editor-content", {
                                    detail: { content: data.chordPro },
                                }),
                            );

                            // Mostrar informaci√≥n de los acordes generados
                            const chordsList =
                                data.chords?.list?.join(", ") || "N/A";
                            alert(
                                `‚úÖ ¬°Acordes generados exitosamente!\n\n` +
                                    `Acordes encontrados: ${chordsList}\n` +
                                    `Total: ${data.chords?.count || 0} acordes √∫nicos`,
                            );
                        } else {
                            throw new Error("Respuesta inv√°lida del servidor");
                        }
                    } catch (error) {
                        console.error("Error al generar acordes:", error);
                        alert(
                            `‚ùå Error al generar acordes\n\n` +
                                `${error instanceof Error ? error.message : "Error desconocido"}\n\n` +
                                `Por favor intenta nuevamente.`,
                        );
                    } finally {
                        // Restaurar bot√≥n
                        btnAI.disabled = false;
                        btnAI.innerHTML =
                            "<span>‚ú®</span> Generar acordes con IA";
                        btnAI.classList.remove(
                            "opacity-75",
                            "cursor-not-allowed",
                        );
                    }
                });
            }

            // --- AI Search Song by Lyrics Logic ---
            const btnAISearch = document.getElementById("btn-ai-search-song");
            console.log("Searching for AI Search Song button...", btnAISearch);

            if (btnAISearch) {
                btnAISearch.addEventListener("click", async () => {
                    console.log("AI Search Song Button Clicked");
                    const titleInput = document.querySelector("#title");
                    const artistInput = document.querySelector("#artist");
                    const contentInput =
                        document.querySelector('[name="content"]');

                    const title = titleInput?.value || "";
                    const artist = artistInput?.value || "";
                    const lyricFragment = contentInput?.value || "";

                    // Validar que haya al menos un fragmento de letra
                    if (!lyricFragment || lyricFragment.trim().length === 0) {
                        alert(
                            "Por favor escribe un fragmento de la letra de la canci√≥n que deseas buscar.\n\n" +
                                "Ejemplo: 'Amazing grace how sweet the sound'",
                        );
                        return;
                    }

                    // Confirmar con el usuario
                    const artistInfo = artist ? ` de ${artist}` : "";
                    const titleInfo = title ? ` (${title})` : "";
                    const confirmResult = confirm(
                        `¬øDeseas buscar la canci√≥n original usando este fragmento de letra?${titleInfo}${artistInfo}\n\n` +
                            `Fragmento: "${lyricFragment.substring(0, 100)}${lyricFragment.length > 100 ? "..." : ""}"\n\n` +
                            `Esto reemplazar√° el contenido actual del editor con la canci√≥n completa encontrada.`,
                    );

                    if (!confirmResult) return;

                    console.log("--- AI Search Song Context ---");
                    console.log("Lyric Fragment:", lyricFragment);
                    console.log("Title (hint):", title);
                    console.log("Artist (hint):", artist);
                    console.log("-------------------------------");

                    try {
                        // Deshabilitar bot√≥n y mostrar estado de carga
                        btnAISearch.disabled = true;
                        const originalText = btnAISearch.innerHTML;
                        btnAISearch.innerHTML =
                            '<span class="animate-pulse">‚è≥ Buscando canci√≥n...</span>';
                        btnAISearch.classList.add(
                            "opacity-75",
                            "cursor-not-allowed",
                        );

                        // Importar din√°micamente el servicio de IA
                        const { searchSongByLyrics } =
                            await import("/src/services/ai.ts");

                        // Llamar al servicio para buscar canci√≥n por letra
                        const result = await searchSongByLyrics(
                            {
                                lyricFragment: lyricFragment,
                                artist: artist || undefined,
                                title: title || undefined,
                            },
                            token,
                        );

                        if (!result.success) {
                            throw new Error(
                                result.error || "Error al buscar la canci√≥n",
                            );
                        }

                        const data = result.data;
                        console.log("AI Search Song Response:", data);

                        if (data && data.chordPro) {
                            // Actualizar campos del formulario con la informaci√≥n encontrada
                            if (data.metadata?.title && titleInput) {
                                titleInput.value = data.metadata.title;
                            }
                            if (data.metadata?.artist && artistInput) {
                                artistInput.value = data.metadata.artist;
                            }
                            if (data.metadata?.key) {
                                const keySelect =
                                    document.querySelector("#key");
                                if (keySelect) {
                                    keySelect.value = data.metadata.key;
                                    // Disparar evento de cambio de tono
                                    window.dispatchEvent(
                                        new CustomEvent("song-key-change", {
                                            detail: { key: data.metadata.key },
                                        }),
                                    );
                                }
                            }

                            // Disparar evento personalizado para que React actualice el editor
                            window.dispatchEvent(
                                new CustomEvent("update-editor-content", {
                                    detail: { content: data.chordPro },
                                }),
                            );

                            // Mostrar informaci√≥n de la canci√≥n encontrada
                            const chordsList =
                                data.chords?.list?.join(", ") || "N/A";
                            const songTitle = data.metadata?.title || "Canci√≥n";
                            const songArtist =
                                data.metadata?.artist || "Desconocido";
                            alert(
                                `‚úÖ ¬°Canci√≥n encontrada!\n\n` +
                                    `T√≠tulo: ${songTitle}\n` +
                                    `Artista: ${songArtist}\n` +
                                    `Tono: ${data.metadata?.key || "N/A"}\n\n` +
                                    `Acordes: ${chordsList}\n` +
                                    `Total: ${data.chords?.count || 0} acordes √∫nicos`,
                            );
                        } else {
                            throw new Error("Respuesta inv√°lida del servidor");
                        }
                    } catch (error) {
                        console.error("Error al buscar canci√≥n:", error);
                        alert(
                            `‚ùå Error al buscar la canci√≥n\n\n` +
                                `${error instanceof Error ? error.message : "Error desconocido"}\n\n` +
                                `Verifica que el fragmento de letra sea correcto y vuelve a intentarlo.`,
                        );
                    } finally {
                        // Restaurar bot√≥n
                        btnAISearch.disabled = false;
                        btnAISearch.innerHTML =
                            "<span>üîç</span> Buscar canci√≥n por letra";
                        btnAISearch.classList.remove(
                            "opacity-75",
                            "cursor-not-allowed",
                        );
                    }
                });
            }

            // --- Key Logic ---
            const keySelect = document.querySelector("#key");

            keySelect?.addEventListener("change", (e) => {
                if (e.target instanceof HTMLSelectElement) {
                    const newKey = e.target.value;
                    const event = new CustomEvent("song-key-change", {
                        detail: { key: newKey },
                    });
                    window.dispatchEvent(event);
                }
            });

            // Escuchar cambios desde el editor de acordes
            window.addEventListener("editor-key-change", (e) => {
                if (e instanceof CustomEvent) {
                    if (keySelect && e.detail && e.detail.key) {
                        keySelect.value = e.detail.key;
                    }
                }
            });
        });
    </script>
</Layout>
