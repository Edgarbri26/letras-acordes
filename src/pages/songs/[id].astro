---
// export const prerender = false;
Astro.response.headers.set("Cache-Control", "public, max-age=60, s-maxage=60");
import Layout from "@/layouts/Layout.astro";
import { SongToolsReact } from "@/components/SongToolsReact";
import SongView from "@/components/SongView";
import { HeaderLyricReact } from "@/components/HeaderLyricReact";
import { YouTubePlayerReact } from "@/components/YouTubePlayerReact";
import "@/styles/global.css";
import type { Song } from "@/types/song";
import { getSongById } from "@/services/songs";
import { getUserFromToken } from "@/utils/auth";
const token = Astro.cookies.get("token")?.value;
const user = getUserFromToken(token);
const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/");
}

const response = await getSongById(id);
let song: Song | null = null;
let seoTitle = "Canci칩n no encontrada | Letra y Acordes";
let seoDescription = "La canci칩n que buscas no est치 disponible.";

if (response.success && response.data) {
    song = response.data;
    seoTitle = `${song.title} - ${song.artist} | Letra y Acordes`;
    seoDescription = `Mi cancionero digital. Acordes y letra de ${song.title} de ${song.artist}. Aprende a tocar esta canci칩n con guitarra, piano o ukulele.`;
} else {
    // Optional: Redirect to 404 if critical
    // return Astro.redirect("/404");
}

const canEdit =
    user &&
    (user.role === "ADMIN" || (song?.userId && user.id === song.userId));
---

<Layout title={seoTitle} description={seoDescription}>
    <div
        class="print-header flex items-center gap-4 mb-2 pb-2 border-b border-gray-300"
    >
        <img
            src="/icono-light.svg"
            alt="Cancionero Digital"
            class="w-10 h-10"
        />
        <div class="flex-1">
            <h1
                transition:name={`song-title-${id}`}
                class="text-3xl font-bold text-black leading-tight"
            >
                {song ? song.title : "Cargando..."}
            </h1>
        </div>
        <div class="text-right">
            <p class="text-gray-400 text-xs">Cancionero Digital</p>
        </div>
    </div>
    <div class="flex flex-1 max-w-[1400px] mx-auto w-full print:block">
        <SongToolsReact
            client:load
            id={id}
            canEdit={!!canEdit}
            onTranspose={undefined}
            onToggleChords={undefined}
            onPrint={undefined}
        />

        <main class="flex-1 p-6 md:p-10 min-w-0 print:px-8 print:py-0">
            <HeaderLyricReact
                id={id}
                title={song?.title}
                artist={song?.artist}
                tone={song?.key}
                category={song?.category}
                user={song?.user}
            />

            <div
                class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start print:block"
            >
                <div class="lg:col-span-2 print:w-full">
                    <SongView
                        client:load
                        initialContent={song?.content}
                        initialKey={song?.key}
                        originalKey={song?.key}
                    />
                </div>
                <div class="lg:col-span-1 no-print">
                    <YouTubePlayerReact url={song?.url_song} client:visible />
                </div>
            </div>
        </main>
    </div>
</Layout>
