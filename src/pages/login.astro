---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";

import { login } from "../services/auth";

let errorMessage = "";

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const email = data.get("email");
        const password = data.get("password");

        const response = await login(email, password);

        if (response && response.ok) {
            // Forward cookies from backend to client
            const setCookie = response.headers.get("set-cookie");

            if (setCookie) {
                // Extract token from cookie string (assuming format "token=...; ...")
                const match = setCookie.match(/token=([^;]+)/);
                const token = match ? match[1] : null;

                if (token) {
                    Astro.cookies.set("token", token, {
                        path: "/",
                        httpOnly: true,
                        secure: import.meta.env.PROD,
                        sameSite: "lax",
                    });
                    return Astro.redirect("/");
                }
            } else {
                // Fallback: try to see if token is in body
                const body = await response.json();
                if (body.token) {
                    Astro.cookies.set("token", body.token, {
                        path: "/",
                        httpOnly: true,
                        secure: import.meta.env.PROD,
                        sameSite: "lax",
                    });
                    return Astro.redirect("/");
                }
            }
            errorMessage = "Error: No se recibió el token de autenticación.";
        } else {
            errorMessage = "Credenciales incorrectas.";
        }
    } catch (error) {
        console.error(error);
        errorMessage = "Error de conexión.";
    }
}
---

<Layout title="Iniciar Sesión - Cancionero">
    <div
        class="flex flex-col min-h-screen bg-bg-main text-text-main items-center justify-center p-4"
    >
        <div
            class="w-full max-w-md bg-bg-secondary p-8 rounded-xl shadow-lg border border-white/5"
        >
            <h1 class="text-2xl font-bold text-accent-main mb-6 text-center">
                Iniciar Sesión
            </h1>

            <form id="loginForm" method="POST" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Correo Electrónico</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="admin@example.com"
                    />
                </div>

                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Contraseña</label
                    >
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="••••••••"
                    />
                </div>

                {
                    errorMessage && (
                        <div
                            id="errorMessage"
                            class="text-red-500 text-sm text-center"
                        >
                            {errorMessage}
                        </div>
                    )
                }

                <button
                    type="submit"
                    class="w-full bg-accent-main text-white font-bold py-3 rounded-lg hover:bg-accent-secondary transition-transform transform active:scale-95"
                >
                    Ingresar
                </button>
            </form>
        </div>
    </div>
</Layout>
