---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import ChordEditor from "../components/ChordEditor.jsx";
import { supabase } from "../lib/supabase";
import "../styles/global.css";

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const artist = formData.get("artist")?.toString() || "Unknown";
        const title = formData.get("title")?.toString() || "Untitled";
        const key = formData.get("key")?.toString() || "C";
        const video = formData.get("video")?.toString() || "";
        const content = formData.get("content")?.toString() || "";

        // Generar ID único (slug simple)
        const id = `${title}-${artist}`
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") // Eliminar tildes
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)+/g, "");

        // Timestamp simple para evitar colisiones si el slug ya existe?
        // Por ahora confiamos en titulo-artista. Si falla, el usuario verá error (o supbase lanzará error duplicate key)

        console.log("Attempting to save song...");
        const { error } = await supabase.from("songs").insert({
            id,
            title,
            artist,
            key,
            video,
            content,
        });

        if (error) {
            console.error(
                "Supabase Error saving song:",
                JSON.stringify(error, null, 2),
            );
            // Podríamos renderizar un error en la UI, pero por simplicidad logueamos
        } else {
            console.log(
                "Song saved successfully! Redirecting to:",
                `/songs/${id}`,
            );
            return Astro.redirect(`/songs/${id}`);
        }
    } catch (e) {
        console.error("Server exception:", e);
    }
}
---

<Layout title="Subir Canción">
    <div class="flex flex-col min-h-screen bg-bg-main text-text-main">
        <Header />

        <main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
            <h1 class="text-3xl font-bold text-accent-main mb-8">
                Enviar Cifrado
            </h1>

            {/* Nota: method="POST" es necesario para procesar datos */}
            <form class="space-y-8" method="POST">
                {/* Info Básica (Grid de 3 columnas para aprovechar espacio) */}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label
                            for="artist"
                            class="block text-sm font-medium text-text-secondary"
                            >Artista / Banda</label
                        >
                        <input
                            type="text"
                            id="artist"
                            name="artist"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Cindy Barrera"
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="title"
                            class="block text-sm font-medium text-text-secondary"
                            >Nombre de la canción</label
                        >
                        <input
                            type="text"
                            id="title"
                            name="title"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                            placeholder="Ej. Dios está aquí"
                        />
                    </div>

                    <div class="space-y-2">
                        <label
                            for="key"
                            class="block text-sm font-medium text-text-secondary"
                            >Tono Principal</label
                        >
                        <select
                            id="key"
                            name="key"
                            class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors appearance-none cursor-pointer"
                        >
                            <option value="C">C (Do)</option>
                            <option value="C#">C# / Db</option>
                            <option value="D">D (Re)</option>
                            <option value="D#">D# / Eb</option>
                            <option value="E">E (Mi)</option>
                            <option value="F">F (Fa)</option>
                            <option value="F#">F# / Gb</option>
                            <option value="G">G (Sol)</option>
                            <option value="G#">G# / Ab</option>
                            <option value="A">A (La)</option>
                            <option value="A#">A# / Bb</option>
                            <option value="B">B (Si)</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label
                        for="video"
                        class="block text-sm font-medium text-text-secondary"
                        >Link del Video (YouTube)</label
                    >
                    <input
                        type="url"
                        id="video"
                        name="video"
                        class="w-full bg-bg-secondary border border-white/10 rounded-lg p-3 text-text-main focus:outline-none focus:border-accent-main transition-colors placeholder-white/20"
                        placeholder="https://youtube.com/..."
                    />
                </div>

                <div class="border-t border-white/10 pt-6">
                    <div class="mb-4">
                        <h3 class="text-xl font-semibold text-white">
                            Letra y Acordes
                        </h3>
                        <p class="text-sm text-text-secondary">
                            Escribe la letra y usa los botones para insertar los
                            acordes en la posición exacta.
                        </p>
                    </div>

                    {/* AQUÍ VA LA MAGIA DE REACT */}
                    {
                        /* Pasamos 'name="content"' para que el form lo reconozca */
                    }
                    <ChordEditor client:only="react" name="content" />
                </div>

                <div class="flex justify-end pt-4">
                    <button
                        type="submit"
                        class="bg-accent-main hover:bg-accent-main/90 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-lg shadow-accent-main/20"
                    >
                        Guardar Canción
                    </button>
                </div>
            </form>
        </main>
    </div>
</Layout>

<script>
    const keySelect = document.getElementById("key") as HTMLSelectElement;

    // Al cargar, aseguramos que el valor inicial se transmita si es necesario,
    // aunque idealmente el editor arranca en C.
    // keySelect.value = "C";

    keySelect?.addEventListener("change", (e) => {
        const newKey = (e.target as HTMLSelectElement).value;
        const event = new CustomEvent("song-key-change", {
            detail: { key: newKey },
        });
        window.dispatchEvent(event);
    });
</script>
