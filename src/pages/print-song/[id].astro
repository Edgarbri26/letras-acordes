---
import SongView from "../../components/SongView.jsx";
import "../../styles/global.css";
import Footer from "../../components/footer.astro";
import { API_URL } from "@/services/songs";

const { id } = Astro.params;


let song = null;
let error = null;
let displayTone = null;

if (id) {
    try {
        const res = await fetch(`${API_URL}/songs/${id}`);
        if (res.ok) {
            song = await res.json();
             // Determine tone
            const toneParam = Astro.url.searchParams.get("tone");
            displayTone = toneParam || song.key;
        } else {
            error = "Canción no encontrada";
        }
    } catch (e) {
        console.error(e);
        error = "Error de conexión";
    }
} else {
    return Astro.redirect("/");
}
---

<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>{song ? `${song.title} - Imprimir` : "Error"}</title>
    </head>
    <body class="bg-white">
        {error ? (
            <div class="print-container"><h1>{error}</h1></div>
        ) : (
            <div class="print-container">
                <div class="print-header">
                     <img src="/medium-logo-light.svg" alt="Cancionero Digital" class="print-logo" />
                     <div>
                        <h1 class="text-accent-main" style="font-size: 24pt; font-weight: bold; margin: 0;">{song.title}</h1>
                        <h2 style="font-size: 14pt; color: #666; margin: 0;">{song.artist}</h2>
                     </div>
                </div>

                <div class="meta" style="margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <span><strong>Tono:</strong> <span class="badge" style="border: 1px solid #ccc; padding: 2px 8px; border-radius: 4px;">{displayTone}</span></span>
                    {displayTone !== song.key && <span>(Original: {song.key})</span>}
                    <span style="margin-left: 20px;"><strong>Categoría:</strong> {song.category?.name || "General"}</span>
                </div>

                <div class="song-content">
                    <SongView 
                        client:load 
                        initialContent={song.content} 
                        initialKey={displayTone} 
                        originalKey={song.key} 
                    />
                </div>


                <script define:vars={{ id, search: Astro.url.search }}>
                    window.onload = () => {
                        window.print();
                    }
                    
                    window.onafterprint = () => {
                        window.location.href = `/songs/${id}${search}`;
                    }
                </script>
            </div>
        )}
        <Footer />
    </body>
</html>
