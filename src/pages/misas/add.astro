---
// export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
const token = Astro.cookies.get("token")?.value;
---

<Layout title="Nueva Misa - CancioneroDigital">
    <main class="max-w-2xl mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100">
            Crear Nueva Misa
        </h1>

        <form
            id="addMisaForm"
            class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-4"
            data-token={token}
        >
            <div>
                <label
                    for="title"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Título / Ocasión</label
                >
                <input
                    type="text"
                    id="title"
                    name="title"
                    required
                    placeholder="Ej. Misa de Domingo, Jueves Santo..."
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border"
                />
            </div>

            <div>
                <label
                    for="dateMisa"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Fecha</label
                >
                <input
                    type="date"
                    id="dateMisa"
                    name="dateMisa"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border dark:[&::-webkit-calendar-picker-indicator]:invert"
                />
            </div>

            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                    >Visibilidad</label
                >
                <select
                    name="visibility"
                    id="visibility"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border"
                >
                    <option value="PUBLIC">Pública</option>
                    <option value="PRIVATE" selected
                        >Privada (Solo tú y enlace)</option
                    >
                </select>
            </div>

            <div class="flex justify-end pt-4">
                <a
                    href="/misas"
                    class="mr-4 px-4 py-2 text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition"
                    >Cancelar</a
                >
                <button
                    type="submit"
                    class="bg-accent-main hover:saturate-200 text-white font-bold py-2 px-4 rounded shadow transition"
                >
                    Crear Misa
                </button>
            </div>
        </form>
    </main>
</Layout>

<script>
    import { createMisa } from "@/services/misas";
    import { showError, showSuccessToast } from "@/utils/alerts";

    const form = document.getElementById("addMisaForm") as HTMLFormElement;
    const submitBtn = form?.querySelector(
        "button[type='submit']",
    ) as HTMLButtonElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const title = formData.get("title") as string;
        const dateMisa = formData.get("dateMisa") as string;
        const visibility = formData.get("visibility") as string;
        const token = form.getAttribute("data-token");

        console.log("add.astro - Form submitted", {
            title,
            dateMisa,
            visibility,
            token: token ? "FOUND" : "MISSING",
        });

        if (!token) {
            console.error(
                "add.astro - Token missing in form attribute data-token",
            );
            await showError(
                "Error",
                "No estás autenticado. Por favor inicia sesión.",
            );
            window.location.href = "/login";
            return;
        }

        // Loading state
        const originalText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Creando...
        `;

        try {
            console.log("add.astro - calling createMisa service");
            const { success, error } = await createMisa(
                title,
                dateMisa,
                visibility,
                token,
            );

            if (success) {
                await showSuccessToast("Misa creada correctamente");
                window.location.href = "/misas";
            } else {
                showError("Error", error || "Error al crear la misa");
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        } catch (err) {
            showError("Error", "Ocurrió un error inesperado");
            submitBtn.disabled = false;
            submitBtn.innerText = originalText;
        }
    });
</script>
