---
// export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
const token = Astro.cookies.get("token")?.value;
---

<Layout title="Nueva Misa - CancioneroDigital">
    <main class="max-w-2xl mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100">
            Crear Nueva Misa
        </h1>

        <form
            id="addMisaForm"
            class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-4"
            data-token={token}
        >
            <div>
                <label
                    for="title"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Título / Ocasión</label
                >
                <input
                    type="text"
                    id="title"
                    name="title"
                    required
                    placeholder="Ej. Misa de Domingo, Jueves Santo..."
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border"
                />
            </div>

            <div>
                <label
                    for="dateMisa"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Fecha</label
                >
                <input
                    type="date"
                    id="dateMisa"
                    name="dateMisa"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border"
                />
            </div>

            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                    >Visibilidad</label
                >
                <select
                    name="visibility"
                    id="visibility"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white p-2 border"
                >
                    <option value="PUBLIC" selected>Pública</option>
                    <option value="PRIVATE">Privada (Solo tú y enlace)</option>
                </select>
            </div>

            <div class="flex justify-end pt-4">
                <a
                    href="/misas"
                    class="mr-4 px-4 py-2 text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition"
                    >Cancelar</a
                >
                <button
                    type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow transition"
                >
                    Crear Misa
                </button>
            </div>
        </form>
    </main>
</Layout>

<script>
    import { createMisa } from "../../services/misas";

    const form = document.getElementById("addMisaForm") as HTMLFormElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const title = formData.get("title") as string;
        const dateMisa = formData.get("dateMisa") as string;
        const visibility = formData.get("visibility") as string;
        const token = form.getAttribute("data-token");

        if (!token) {
            alert("No estás autenticado. Por favor inicia sesión.");
            window.location.href = "/login";
            return;
        }

        const { success, error } = await createMisa(
            title,
            dateMisa,
            visibility,
            token,
        );

        if (success) {
            window.location.href = "/misas";
        } else {
            alert(error || "Error al crear la misa");
        }
    });
</script>
