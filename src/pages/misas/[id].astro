---
// export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import { getMisas } from "../../services/misas";
import { getMoments } from "@/services/moments";
import MisaSongManager from "@/components/MisaSongManager";
import type { Moment } from "@/types/misa";

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000/api";

let misa = null;
let error = null;
let moments: Moment[] = [];
let token = Astro.cookies.get("token")?.value;

if (id) {
    try {
        const [misaRes, momentsRes] = await Promise.all([
            fetch(`${API_URL}/misas/${id}`),
            getMoments(),
        ]);

        if (misaRes.ok) {
            misa = await misaRes.json();
        } else {
            error = "No se encontr√≥ la misa.";
        }

        if (momentsRes.success && momentsRes.data) {
            moments = momentsRes.data;
        }
    } catch (e) {
        error = "Error de conexi√≥n.";
    }
}

// Helper to format date
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};
---

<Layout
    title={misa ? `${misa.title} - CancioneroDigital` : "Misa no encontrada"}
>
    <main class="max-w-4xl mx-auto p-4">
        {
            error ? (
                <div class="text-center py-10">
                    <p class="text-red-500 font-bold text-xl">{error}</p>
                    <a
                        href="/misas"
                        class="text-blue-500 hover:underline mt-4 block"
                    >
                        Volver a Misas
                    </a>
                </div>
            ) : misa ? (
                <div>
                    <div class="mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
                                    {misa.title}
                                </h1>
                                <p class="text-gray-600 dark:text-gray-400 mt-1 capitalize">
                                    üìÖ {formatDate(misa.dateMisa)}
                                </p>
                            </div>
                            {token && (
                                <button class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                                    Editar Info
                                </button>
                            )}
                        </div>
                    </div>

                    <div class="space-y-6">
                        {moments.map((moment) => {
                            const momentSongs = misa.misaSongs.filter(
                                (ms: any) => ms.momentId === moment.id,
                            );

                            return (
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center justify-start gap-2">
                                        <h2 class="text-xl font-bold">
                                            {moment.nombre}:
                                        </h2>

                                        {momentSongs.map((ms: any) => (
                                            <div class="flex items-center gap-1 group">
                                                <a
                                                    href={`/songs/${ms.song.id}`}
                                                    class="text-sm text-white bg-accent-main/30 border-2 border-accent-main
                                                    rounded-full px-4 py-2 text-center font-medium hover:text-white hover:bg-accent-main transition flex items-center gap-2"
                                                >
                                                    <span class="text-center">
                                                        {ms.song.title}
                                                    </span>
                                                    <span class="text-xs font-bold text-accent-main bg-white/20 px-1.5 py-0.5 rounded">
                                                        {ms.key || ms.song.key}
                                                    </span>
                                                </a>
                                                {token && (
                                                    <button
                                                        data-action="delete-song"
                                                        data-misa-id={misa.id}
                                                        data-misa-song-id={
                                                            ms.id
                                                        }
                                                        class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        title="Eliminar canci√≥n"
                                                    >
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            width="16"
                                                            height="16"
                                                            viewBox="0 0 24 24"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            stroke-width="2"
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                        >
                                                            <path d="M3 6h18" />
                                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        ))}

                                        {token && (
                                            <button
                                                data-moment-id={moment.id}
                                                class="add-song-btn text-sm h-10 w-10 bg-accent-main text-white font-bold rounded-lg hover:saturate-200 transition-transform transform active:scale-95 flex items-center justify-center"
                                            >
                                                +
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div class="mt-8 flex justify-between">
                        <a
                            href="/misas"
                            class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition"
                        >
                            ‚Üê Volver al listado
                        </a>
                        {/* Aqui podriamos poner un boton para Editar Misa o Agregar Canciones */}
                    </div>

                    {token ? (
                        <MisaSongManager
                            client:load
                            misaId={misa.id}
                            moments={moments}
                            token={token}
                        />
                    ) : (
                        <div class="mt-8 text-center p-6 bg-gray-50 dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Inicia sesi√≥n para agregar canciones y editar la
                                misa.
                            </p>
                            <a
                                href="/login"
                                class="inline-block bg-accent-main text-white font-medium px-6 py-2 rounded-lg hover:bg-accent-main/90 transition-colors"
                            >
                                Iniciar Sesi√≥n
                            </a>
                        </div>
                    )}
                </div>
            ) : (
                <div class="text-center py-10">
                    <p class="text-gray-500">Cargando...</p>
                </div>
            )
        }
    </main>
</Layout>

<script>
    import { removeSongFromMisa } from "../../services/misas";
    declare global {
        interface Window {
            openAddSongModal: (momentId: string | null) => void;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const buttons = document.querySelectorAll(".add-song-btn");
        buttons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const momentId = btn.getAttribute("data-moment-id");

                console.log(
                    "Button clicked, calling global function for:",
                    momentId,
                );

                if (window.openAddSongModal) {
                    window.openAddSongModal(momentId);
                } else {
                    console.error(
                        "MisaSongManager is not ready or not loaded.",
                    );
                    alert(
                        "Error: El gestor de canciones no est√° cargado. Intenta recargar la p√°gina.",
                    );
                }
            });
        });

        const deleteButtons = document.querySelectorAll(
            'button[data-action="delete-song"]',
        );
        deleteButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                // e.stopPropagation(); // Avoid triggering parent clicks if any

                if (!confirm("¬øSeguro que quieres eliminar esta canci√≥n?"))
                    return;

                const misaId = Number(btn.getAttribute("data-misa-id"));
                const misaSongId = Number(
                    btn.getAttribute("data-misa-song-id"),
                );

                const getCookie = (name: string) => {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2)
                        return parts.pop()?.split(";").shift();
                };
                const token = getCookie("token");

                if (misaId && misaSongId) {
                    try {
                        const res = await removeSongFromMisa(
                            misaId,
                            misaSongId,
                            token,
                        );
                        if (res.success) {
                            window.location.reload();
                        } else {
                            alert(res.error || "Error al eliminar.");
                        }
                    } catch (error) {
                        console.error(error);
                        alert("Error de conexi√≥n.");
                    }
                }
            });
        });
    });
</script>
