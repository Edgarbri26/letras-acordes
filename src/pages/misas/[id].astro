---
// export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import { getMisas } from "../../services/misas";

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000/api";

let misa = null;
let error = null;

if (id) {
    try {
        const res = await fetch(`${API_URL}/misas/${id}`);
        if (res.ok) {
            misa = await res.json();
        } else {
            error = "No se encontr√≥ la misa.";
        }
    } catch (e) {
        error = "Error de conexi√≥n.";
    }
}

// Helper to format date
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};
---

<Layout
    title={misa ? `${misa.title} - CancioneroDigital` : "Misa no encontrada"}
>
    <Header />
    <main class="max-w-4xl mx-auto p-4">
        {
            error ? (
                <div class="text-center py-10">
                    <p class="text-red-500 font-bold text-xl">{error}</p>
                    <a
                        href="/misas"
                        class="text-blue-500 hover:underline mt-4 block"
                    >
                        Volver a Misas
                    </a>
                </div>
            ) : misa ? (
                <div>
                    <div class="mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
                            {misa.title}
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1 capitalize">
                            üìÖ {formatDate(misa.dateMisa)}
                        </p>
                    </div>

                    <div class="space-y-4">
                        {misa.misaSongs && misa.misaSongs.length > 0 ? (
                            misa.misaSongs.map((ms: any) => (
                                <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                                    <div>
                                        <span class="text-xs font-semibold uppercase tracking-wider text-blue-600 dark:text-blue-400 block mb-1">
                                            {ms.moment?.nombre || "Canci√≥n"}
                                        </span>
                                        <a
                                            href={`/songs/${ms.song.id}`}
                                            class="text-lg font-medium hover:text-blue-500 transition"
                                        >
                                            {ms.song.title}
                                        </a>
                                        <p class="text-sm text-gray-500">
                                            {ms.song.artist}
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 text-xs px-2 py-1 rounded">
                                            {ms.key || ms.song.key}
                                        </span>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <p class="text-gray-500 italic">
                                No hay canciones asignadas a esta misa a√∫n.
                            </p>
                        )}
                    </div>

                    <div class="mt-8 flex justify-between">
                        <a
                            href="/misas"
                            class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition"
                        >
                            ‚Üê Volver al listado
                        </a>
                        {/* Aqui podriamos poner un boton para Editar Misa o Agregar Canciones */}
                    </div>
                </div>
            ) : (
                <div class="text-center py-10">
                    <p class="text-gray-500">Cargando...</p>
                </div>
            )
        }
    </main>
</Layout>
