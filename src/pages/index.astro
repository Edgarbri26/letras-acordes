---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import { supabase } from "../lib/supabase";
import "../styles/global.css";

import type { Song } from "../types/song";
import type { Category } from "../types/category";

let songs: Song[] = [];
let categories: Category[] = [];
let error = null;

try {
	const q = Astro.url.searchParams.get("q") || "";
	const categoryId = Astro.url.searchParams.get("categoryId") || "";

	// Fetch songs
	const res = await fetch(
		`http://localhost:3000/api/songs?q=${encodeURIComponent(q)}&categoryId=${categoryId}`,
	);
	if (!res.ok) throw new Error("Failed to fetch songs");
	songs = await res.json();
	// Invert sorting if backend doesn't sort (or rely on backend sort)
	// The backend `findMany` doesn't currently order by created_at,
	// we can add sorting there or here. For now, we take as is.
	songs.reverse();

	// Fetch categories
	const catRes = await fetch(`http://localhost:3000/api/categories`);
	if (catRes.ok) {
		categories = await catRes.json();
	}
} catch (e) {
	if (e instanceof Error) {
		error = e.message;
	} else {
		error = String(e);
		console.error("Error fetching songs:", error);
	}
}

const currentCategoryId = Astro.url.searchParams.get("categoryId");
---

<Layout title="CancioneroDigital - Tus canciones">
	<div class="flex flex-col min-h-screen bg-bg-main text-text-main">
		<Header />

		<main class="flex-1 max-w-6xl mx-auto w-full p-6 md:p-10">
			<h1 class="text-3xl font-bold text-accent-main mb-8">
				Últimas Canciones
			</h1>

			<!-- Categorías -->
			<div class="flex flex-wrap gap-2 mb-8">
				<a
					href="/"
					class={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${!currentCategoryId ? "bg-accent-main text-white" : "bg-bg-secondary text-text-secondary hover:text-white hover:bg-white/10"}`}
				>
					Todas
				</a>
				{
					categories.map((cat) => (
						<a
							href={`/?categoryId=${cat.id}`}
							class={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${currentCategoryId === String(cat.id) ? "bg-accent-main text-white" : "bg-bg-secondary text-text-secondary hover:text-white hover:bg-white/10"}`}
						>
							{cat.name}
						</a>
					))
				}
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
				{
					songs?.map((song) => (
						<a href={`/songs/${song.id}`} class="block group">
							<article class="bg-bg-secondary border border-white/5 rounded-xl p-5 hover:border-accent-main/50 transition-colors h-full">
								<h2 class="text-xl font-bold text-white group-hover:text-accent-main transition-colors mb-1 truncate">
									{song.title}
								</h2>
								<p class="text-text-secondary text-sm mb-4">
									{song.artist}
								</p>

								<div class="flex items-center gap-2">
									<span class="text-xs bg-white/5 px-2 py-1 rounded text-text-secondary group-hover:bg-accent-main/10 group-hover:text-accent-main transition-colors">
										Tom: {song.key}
									</span>
									<span class="text-xs bg-white/5 px-2 py-1 rounded text-text-secondary group-hover:bg-accent-main/10 group-hover:text-accent-main transition-colors">
										Categoría: {song.category?.name}
									</span>
								</div>
							</article>
						</a>
					))
				}
			</div>

			{
				(!songs || songs.length === 0) && (
					<div class="text-center py-20 opacity-50">
						<p class="text-xl mb-4">No hay canciones todavía</p>
						<a
							href="/add-song"
							class="text-accent-main hover:underline"
						>
							¡Sube la primera!
						</a>
					</div>
				)
			}
		</main>
	</div>
</Layout>
